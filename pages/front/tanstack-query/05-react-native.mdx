---
title: '05-React Native'
date: 2023/12/14
---

## 1. React Native

React QueryëŠ” React DOMì—ì„œë§Œ ì§€ì›ë˜ëŠ” DevToolsë¥¼ ì œì™¸í•˜ê³  ë™ì‘í•œë‹¤.

ì‹œë„í•´ ë³¼ ë§Œí•œ ì„œë“œíŒŒí‹° Flipper í”ŒëŸ¬ê·¸ì¸ì´ ìˆë‹¤
https://github.com/bgaleotti/react-query-native-devtools

ì‹œë„í•´ ë³¼ ë§Œí•œ ì„œë“œíŒŒí‹° Reactotron í”ŒëŸ¬ê·¸ì¸ì´ ìˆë‹¤.
https://github.com/hsndmr/reactotron-react-query

> ğŸ’¡ ì„œë“œíŒŒí‹°(Third Party)ì˜ ì‚¬ì „ì  ì •ì˜ëŠ” 'ì œ3ì'ë¥¼ ì˜ë¯¸
>
> ITì—…ê³„ì—ì„œ ì„œë“œíŒŒí‹°ëŠ” ì–´ë– í•œ ë¶„ì•¼ì—ì„œ ì²˜ìŒ ê°œë°œí•˜ê±°ë‚˜ ì›ì²œê¸°ìˆ ì„ ê°€ì§€ê³  ìˆëŠ” ê²Œ ì•„ë‹Œ, ì›ì²œê¸°ìˆ ê³¼ í˜¸í™˜ë˜ëŠ” ìƒí’ˆì„ ì¶œì‹œí•˜ê±°ë‚˜ í•´ë‹¹ ê¸°ìˆ ì„ ì´ìš©í•œ íŒŒìƒìƒí’ˆì„ ìƒì‚°í•˜ëŠ” íšŒì‚¬

---

## 2. ì˜¨ë¼ì¸ ìƒíƒœ ê´€ë¦¬

React QueryëŠ” ì´ë¯¸ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì¬ì—°ê²° ì‹œ ìë™ ì¬ì„¤ì •ì„ ì§€ì›í•œë‹¤.
React Nativeì—ì„œë„ ì¶”ê°€í•˜ë ¤ë©´, ì•„ë˜ ì˜ˆì™€ ê°™ì´ React Query `onlineManager`ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤:

```tsx
import NetInfo from '@react-native-community/netinfo'
import { onlineManager } from '@tanstack/react-query'

onlineManager.setEventListener(setOnline => {
  return NetInfo.addEventListener(state => {
    setOnline(!!state.isConnected)
  })
})
```

---

## 3. App focusì—ì„œ Refetch

ì›¹ì˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ëŒ€ì‹ ì—, React NativeëŠ” AppState module í†µí•´ focus ì •ë³´ë¥¼ ì œê³µí•œë‹¤.
AppState "change" ì´ë²¤íŠ¸ë¥¼ ì‚¬ìš©í•´, ì•± ìƒíƒœê°€ "active"ë¡œ ë³€ê²½ë  ë•Œ ì—…ë°ì´íŠ¸ë¥¼ íŠ¸ë¦¬ê±°í•  ìˆ˜ ìˆë‹¤:

```tsx
import { useEffect } from 'react'
import { AppState, Platform } from 'react-native'
import type { AppStateStatus } from 'react-native'
import { focusManager } from '@tanstack/react-query'

function onAppStateChange(status: AppStateStatus) {
  if (Platform.OS !== 'web') {
    focusManager.setFocused(status === 'active')
  }
}

useEffect(() => {
  const subscription = AppState.addEventListener('change', onAppStateChange)

  return () => subscription.remove()
}, [])
```

---

## 4. Screen focusì—ì„œ Refetch

ì¼ë¶€ ìƒí™©ë“¤ì—ì„œ, React Native Screenì´ ë‹¤ì‹œ í¬ì»¤ì‹±ë  ë•Œ,
queryë¥¼ refetchí•˜ê¸°ë¥¼ ì›í•  ìˆ˜ ìˆë‹¤.
ì´ custom hookì€ Screenì´ ë‹¤ì‹œ í¬ì»¤ì‹±ë  ë•Œ, ì œê³µëœ refetch í•¨ìˆ˜ë¥¼ ì œê³µí•œë‹¤.

```tsx
import React from 'react'
import { useFocusEffect } from '@react-navigation/native'

export function useRefreshOnFocus<T>(refetch: () => Promise<T>) {
  const firstTimeRef = React.useRef(true)

  useFocusEffect(
    React.useCallback(() => {
      if (firstTimeRef.current) {
        firstTimeRef.current = false
        return
      }

      refetch()
    }, [refetch]),
  )
}
```

ìœ„ì˜ ì½”ë“œì—ì„œ, refetchëŠ” () ì²˜ìŒì— ìƒëµëœë‹¤.  
(,ì™œë‚˜í•˜ë©´ useFocusEffectê°€ screen focusê°€ ì¶”ê°€ëœ mountì—ì„œ ì½œë°±ì„ í˜¸ì¶œí•˜ê¸° ë•Œë¬¸ì—,)

---

## 5. out of focus Screensì—ì„œ re-renders ë§‰ê¸°

ì„±ëŠ¥ ë¬¸ì œë¥¼ í¬í•¨í•œ ì¼ë¶€ ìƒí™©ì—ì„œëŠ”,
React Native í™”ë©´ì´ í¬ì»¤ìŠ¤ë¥¼ ë²—ì–´ë‚  ë•Œ, re-rendersì„ ì¤‘ì§€í•  ìˆ˜ ìˆë‹¤.
ì´ë¥¼ ë‹¬ì„±í•˜ê¸° ìœ„í•´, `NotifyOnChangeProps` ì¿¼ë¦¬ ì˜µì…˜ê³¼ í•¨ê»˜,
`@react-navigation/native`ì˜ `FocusEffect`ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

ì´ ì»¤ìŠ¤í…€ Hookì€ () `NotifyOnChangeProps` ì˜µì…˜ì„ ì œê³µí•œë‹¤.
(í™”ë©´ì´ ì´ˆì ì„ ë²—ì–´ë‚  ë•Œë§ˆë‹¤ ë¹ˆ ë°°ì—´ì„ ë°˜í™˜í•˜ëŠ”)
(`NotifyOnChangeProps` - í•´ë‹¹ ì‹œë‚˜ë¦¬ì˜¤ì— ëŒ€í•œ ì¬ë Œë”ë§ì„ íš¨ê³¼ì ìœ¼ë¡œ ë§‰ëŠ”)

í™”ë©´ì´ ë‹¤ì‹œ ì´ˆì (focus)ì„ ë§ì¶œ ë•Œë§ˆë‹¤, ì¬ì •ìƒìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.

```tsx
import React from 'react'
import { NotifyOnChangeProps } from '@tanstack/query-core'
import { useFocusEffect } from '@react-navigation/native'

export function useFocusNotifyOnChangeProps(notifyOnChangeProps?: NotifyOnChangeProps) {
  const focusedRef = React.useRef(true)

  // ì—¬ê¸°
  useFocusEffect(
    React.useCallback(() => {
      focusedRef.current = true

      return () => {
        focusedRef.current = false
      }
    }, []),
  )

  return () => {
    if (!focusedRef.current) {
      return []
    }

    if (typeof notifyOnChangeProps === 'function') {
      return notifyOnChangeProps()
    }

    return notifyOnChangeProps.current
  }
}
```

ìœ„ ì½”ë“œì—ì„œ, `useFocusEffect`ëŠ” () ì‚¬ìš©ëœë‹¤.
(ì½œë°±ì¡°ê±´ìœ¼ë¡œ ì‚¬ìš©í•  ê¸°ì¤€ê°’ì„ ë³€ê²½í•˜ëŠ”ë°,)

ì´ ì¸ì(argument)ê°€ () ë³´ì¥í•˜ê¸° ìœ„í•´ ì°¸ì¡°ë¥¼ ê°ì‹¼ë‹¤.  
(ë°˜í™˜ëœ ì½œë°±ì´ í•­ìƒ ë™ì¼í•œ ì°¸ì¡°ë¥¼ ìœ ì§€í•œë‹¤ëŠ” ê²ƒì„,)

ì‚¬ìš© ì˜ˆ:

```tsx
function MyComponent() {
  const notifyOnChangeProps = useFocusNotifyOnChangeProps()

  const { dataUpdatedAt } = useQuery({
    queryKey: ['myKey'],
    queryFn: async () => {
      const response = await fetch('https://api.github.com/repos/tannerlinsley/react-query')
      return response.json()
    },
    notifyOnChangeProps,
  })

  return <div>DataUpdatedAt: {dataUpdatedAt}</div>
}
```
