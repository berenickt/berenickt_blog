---
title: '08-TypeORM-Theory'
date: 2023/12/25
---

## 1. Typeormê³µë¶€ìš© í”„ë¡œì íŠ¸

Typeormê³µë¶€ìš© ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ë§Œë“­ì‹œë‹¤.

```bash
nest new typeorm
yarn add @nestjs/typeorm typeorm pg
```

```dockerfile docker-compose.yaml
# ì„œë¹„ìŠ¤ì •ì˜
services:
  postgres:
    image: postgres:15
    # ì‹¤í–‰ì‹œë§ˆë‹¤ ì¬ì‹œì‘
    restart: always
    # ë„ì»¤ì»´í¬ì¦ˆ íŒŒì¼ì— ì¡´ì¬í•˜ëŠ” ìœ„ì¹˜ì— ì‹¤ì œ ë°ì´í„°ë¥¼ hostOSì— ì €ì¥
    volumes:
      # í˜„ì¬ ë„ì»¤ì»´í¬ì¦ˆ íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ” ê²½ë¡œ : ì´ë¯¸ì§€ì•ˆì—ì¡´ì¬í•˜ëŠ” ê²½ë¡œ ë§¤í•‘
      - ./postgres-data:/var/lib/postgresql/data
    ports:
      # hostport:ì´ë¯¸ì§€ì˜í¬íŠ¸
      # 5432í¬íŠ¸ ìš”ì²­ -> ì´ë¯¸ì§€ì˜ í¬íŠ¸ë¡œ ìš”ì³¥
      - '5808:5432'
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: typeormstudy
```

```ts app.module.ts
import { Module } from '@nestjs/common'
import { TypeOrmModule } from '@nestjs/typeorm'

import { AppController } from './app.controller'
import { AppService } from './app.service'

@Module({
  imports: [
    TypeOrmModule.forRoot({
      // ë°ì´í„°ë² ì´ìŠ¤ íƒ€ì…
      type: 'postgres',
      host: '127.0.0.1',
      port: 5808,
      username: 'postgres',
      password: 'postgres',
      database: 'typeormstudy',
      // entitiesí´ë”ì— ì‘ì„±í•œ PostsModel ê°€ì ¸ì˜¤ê¸°
      entities: [],
      synchronize: true,
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

---

## 2. Column Annotationë“¤

`src/entity/user.entity.ts` íŒŒì¼ì„ ë§Œë“­ë‹ˆë‹¤.

```ts user.entity.ts
import {
  Column,
  CreateDateColumn,
  Entity,
  Generated,
  PrimaryGeneratedColumn,
  UpdateDateColumn,
  VersionColumn,
} from 'typeorm'

@Entity()
export class UserModel {
  /*** ID
   * ìë™ìœ¼ë¡œ IDë¥¼ ìƒì„±í•œë‹¤.
   *
   * ğŸ“Œ @PrimaryGeneratedColumn()
   * Primary Columnì€ ëª¨ë“  í…Œì´ë¸”ì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì¡´ì¬í•´ì•¼ í•œë‹¤
   * í…Œì´ë¸” ì•ˆì—ì„œ ê°ê°ì˜ Rowë¥¼ êµ¬ë¶„í•  ìˆ˜ ìˆëŠ” ì»¬ëŸ¼ì´ë‹¤.
   * @PrimaryColumn()
   *
   * ğŸ“Œ @PrimaryGeneratedColumn('uuid')
   * PrimaryGeneratedColumn => ìˆœì„œëŒ€ë¡œ ìœ„ë¡œ ì˜¬ë¼ê°„ë‹¤.
   * 1, 2, 3, 4, 5 -> 999999
   *
   * UUID : ì ˆëŒ€ë¡œ ê²¹ì¹˜ì§€ ì•ŠëŠ” ê³ ìœ í•œ ê°’ì„ ë§Œë“¤ì–´ì¤Œ
   * ea36ed96-8d1c-44d9-9fbe-4ec6960e95a8
   */
  @PrimaryGeneratedColumn()
  id: number

  @Column()
  title: string

  /** ë°ì´í„° ìƒì„± ì¼ì
   * ë°ì´í„°ê°€ ìƒì„±ë˜ëŠ” ë‚ ì§œì™€ ì‹œê°„ì´ ìë™ìœ¼ë¡œ ì°íŒë‹¤.
   */
  @CreateDateColumn()
  createdAt: Date

  /** ë°ì´í„° ìˆ˜ì • ì¼ì
   * ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ë˜ëŠ” ë‚ ì§œì™€ ì‹œê°„ì´ ìë™ìœ¼ë¡œ ì°íŒë‹¤.
   */
  @UpdateDateColumn()
  updateAt: Date

  /** ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ ë  ë–„ë§ˆë‹¤ 1ì”© ì˜¬ë¼ê°„ë‹¤
   * ì²˜ìŒ ìƒì„±ë˜ë©´ ê°’ì€ 1ì´ë‹¤.
   * save() í•¨ìˆ˜ê°€ ëª‡ ë²ˆ ë¶ˆë ¸ëŠ”ì§€ ê¸°ì–µí•œë‹¤.
   */
  @VersionColumn()
  version: number

  /**
   * ğŸ“Œ @Generated('increment')
   * additionalId: number
   * PrimaryColumnì€ ì•„ë‹Œë°, ë°ì´í„° ìƒì„±í•  ë–„ë§ˆë‹¤, 1ì”© ì˜¬ë¼ê°€ëŠ” ì»¬ëŸ¼
   *
   * ğŸ“Œ Generated('uuid')
   * additionalId: string
   * ëŠ” ë§ˆì°¬ê°€ì§€ë¡œ,
   * PrimaryColumnì€ ì•„ë‹Œë°, ë°ì´í„° ìƒì„±í•  ë–„ë§ˆë‹¤, ê³ ìœ ê°’ì„ ê°€ì§€ëŠ” ì»¬ëŸ¼
   */
  @Column()
  @Generated('uuid')
  additionalId: string
}
```

```ts app.module.ts
import { Module } from '@nestjs/common'
import { TypeOrmModule } from '@nestjs/typeorm'

import { AppController } from './app.controller'
import { AppService } from './app.service'
import { UserModel } from './entity/user.entity'

@Module({
  imports: [
    TypeOrmModule.forFeature([UserModel]),
    TypeOrmModule.forRoot({
      // ë°ì´í„°ë² ì´ìŠ¤ íƒ€ì…
      type: 'postgres',
      host: '127.0.0.1',
      port: 5808,
      username: 'postgres',
      password: 'postgres',
      database: 'typeormstudy',
      // entitiesí´ë”ì— ì‘ì„±í•œ Model ê°€ì ¸ì˜¤ê¸°
      entities: [UserModel],
      synchronize: true,
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

```ts app.controller.ts
import { Controller, Get, Param, Patch, Post } from '@nestjs/common'
import { InjectRepository } from '@nestjs/typeorm'
import { UserModel } from './entity/user.entity'
import { Repository } from 'typeorm'

@Controller()
export class AppController {
  constructor(
    @InjectRepository(UserModel)
    private readonly userRepository: Repository<UserModel>
  ) {}

  @Post('users')
  postUser() {
    return this.userRepository.save({
      title: 'test title',
    })
  }

  @Get('users')
  getUsers() {
    return this.userRepository.find()
  }

  @Patch('users/:id')
  async patchUser(@Param('id') id: string) {
    const user = await this.userRepository.findOne({
      where: { id: parseInt(id) },
    })

    return this.userRepository.save({
      ...user,
      title: user.title + '0',
    })
  }
}
```

---

## 3. Column Property ì •ë¦¬

|   ì†ì„±(property)   | ì„¤ëª…                                                                     |
| :----------------: | ------------------------------------------------------------------------ |
| type : ColumnType  | ì¹¼ëŸ¼ íƒ€ì…. varchar, text, int, boolë“± ì¹¼ëŸ¼ íƒ€ì…                          |
|   name : string    | ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë  ì¹¼ëŸ¼ ì´ë¦„, ê¸°ë³¸ê°’ì€ í”„ë¡œí¼í‹° ì´ë¦„ì„ ë”°ë¦„           |
| nullable : boolean | null ê°’ì´ ê°€ëŠ¥í•œì§€ ì—¬ë¶€. ê¸°ë³¸ê°’ì€ false                                  |
|  update : boolean  | ì—…ë°ì´íŠ¸ ê°€ëŠ¥ ì—¬ë¶€. falseì¼ ê²½ìš° ì €ì¥ í›„ ì—…ë°ì´íŠ¸ ë¶ˆê°€. ê¸°ë³¸ê°’ true      |
|  select : boolean  | ì¿¼ë¦¬ ì‹¤í–‰ ì‹œ í”„ë¡œí¼í‹°ë¥¼ ê°€ì ¸ì˜¬ì§€ ê²°ì •. falseì¼ ê²½ìš° ê°€ì ¸ì˜¤ì§€ ì•ŠëŠ”ê²Œ ê¸°ë³¸ |
|  default : string  | ì¹¼ëŸ¼ ê¸°ë³¸ê°’                                                              |
|  unique : boolean  | unique constraint ì ìš© ì—¬ë¶€. ê¸°ë³¸ false                                  |
|  comment : string  | ì¹¼ëŸ¼ ì½”ë©˜íŠ¸. ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì§€ì›ë˜ì§„ ì•ŠìŒ                         |
|  enum : string[]   | ì¹¼ëŸ¼ì— ì…ë ¥ ê°€ëŠ¥í•œ ê°’ì„ enumìœ¼ë¡œ ë‚˜ì—´                                    |
|  Array : boolean   | ì¹¼ëŸ¼ array íƒ€ì…ìœ¼ë¡œ ìƒì„± (e.g. `int[]`)                                  |

```ts user.entity.ts
// user.entity.ts ìƒëµ
@Column({
  type: 'varchar',
  name: 'title',
  length: 300,
  nullable: true,
  update: true,
  select: false,
  default: 'default value',
  unique: false,
})
title: string
```

```ts app.controller.ts
// app.controller.ts ìƒëµ
@Post('users')
postUser() {
  return this.userRepository.save({
    // title: 'test title',
  })
}

@Get('users')
getUsers() {
  return this.userRepository.find({
    select: { id: true, title: true },
  })
}
```

---

## 4. Enum Column

```ts user.entity.ts
export enum Role {
  USER = 'user',
  ADMIN = 'admin',
}

@Entity()
export class UserModel {
  // ìƒëµ
  title: string

  @Column({
    type: 'enum',
    enum: Role,
    default: Role.USER,
  })
  role: Role

  // ìƒëµ
}
```

```ts app.controller.ts
@Post('users')
postUser() {
  return this.userRepository.save({
    // title: 'test title',
    role: Role.ADMIN, // ê´€ë¦¬ì ì—­í• ì„ ë„£ê³ ì‹¶ì„ ë–„
  })
}

// app.controller.tsì˜ selectì˜µì…˜ ì§€ìš°ê¸°
@Get('users')
getUsers() {
  return this.userRepository.find({})
}
```

---

## 5. Entity Embedding

`src/entity/person.entity.ts` íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts person.entity.ts
import { Column, Entity, PrimaryColumn } from 'typeorm'

export class Name {
  @Column()
  first: string

  @Column()
  last: string
}

@Entity()
export class StudentModel {
  @PrimaryColumn()
  id: number

  @Column(() => Name)
  name: Name

  @Column()
  class: string
}

@Entity()
export class TeacherModel {
  @PrimaryColumn()
  id: number

  @Column(() => Name)
  name: Name

  @Column()
  salary: number
}
```

`app.module.ts`ì— ìƒì„±í•œ ëª¨ë“ˆì„ ì¶”ê°€í•œë‹¤.

```ts app.module.ts
// ìƒëµ
@Module({
  imports: [
    TypeOrmModule.forFeature([UserModel]),
    TypeOrmModule.forRoot({
      // ë°ì´í„°ë² ì´ìŠ¤ íƒ€ì…
      type: 'postgres',
      host: '127.0.0.1',
      port: 5808,
      username: 'postgres',
      password: 'postgres',
      database: 'typeormstudy',
      // entitiesí´ë”ì— ì‘ì„±í•œ Model ê°€ì ¸ì˜¤ê¸°
      entities: [UserModel, StudentModel, TeacherModel],
      synchronize: true,
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

DBì— ë“¤ì–´ê°„ ì»¬ëŸ¼ëª…ì„ í™•ì¸í•´ë³´ë©´, `nameFirst`, `nameLast`ë¡œ ë“¤ì–´ê°„ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

---

## 6. Entity Inheritance

`src/entity/inheritance.entity.ts` íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts inheritance.entity.ts
import { Column, CreateDateColumn, Entity, PrimaryGeneratedColumn, UpdateDateColumn } from 'typeorm'

export class BaseModel {
  @PrimaryGeneratedColumn()
  id: number

  @CreateDateColumn()
  createdAt: Date

  @UpdateDateColumn()
  updateat: Date
}

@Entity()
export class BookModel extends BaseModel {
  @Column()
  name: string
}

@Entity()
export class CarModel extends BaseModel {
  @Column()
  brand: string
}
```

`app.module.ts`ì— ìƒì„±í•œ ëª¨ë“ˆì„ ì¶”ê°€í•œë‹¤.

```ts app.module.ts
@Module({
  imports: [
    TypeOrmModule.forFeature([UserModel]),
    TypeOrmModule.forRoot({
      // ë°ì´í„°ë² ì´ìŠ¤ íƒ€ì…
      type: 'postgres',
      host: '127.0.0.1',
      port: 5808,
      username: 'postgres',
      password: 'postgres',
      database: 'typeormstudy',
      // entitiesí´ë”ì— ì‘ì„±í•œ Model ê°€ì ¸ì˜¤ê¸°
      entities: [
        UserModel,
        StudentModel, //
        TeacherModel,
        BookModel,
        CarModel,
      ],
      synchronize: true,
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

DBì— ë“¤ì–´ê°„ ì»¬ëŸ¼ëª…ì„ í™•ì¸í•´ë³´ë©´, ìƒì†ë°›ì€ ì†ì„±ì´ ë“¤ì–´ê°„ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
í‰ì†Œì—ëŠ” ìœ„ì™€ ê°™ì€ ì¼ë°˜ì ì¸ ìƒì†ì„ ì“°ëŠ” ê²ƒì´ ì¢‹ë‹¤.
ë‹¤ë§Œ, êµ³ì´ í•˜ë‚˜ì˜ í…Œì´ë¸”ë¡œ ê´€ë¦¬í•´ì•¼ í•˜ëŠ” ê²½ìš°ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

```ts inheritance.entity.ts
import {
  ChildEntity,
  Column,
  CreateDateColumn,
  Entity,
  PrimaryGeneratedColumn,
  TableInheritance,
  UpdateDateColumn,
} from 'typeorm'

export class BaseModel {
  @PrimaryGeneratedColumn()
  id: number

  @CreateDateColumn()
  createdAt: Date

  @UpdateDateColumn()
  updateat: Date
}

@Entity()
export class BookModel extends BaseModel {
  @Column()
  name: string
}

@Entity()
export class CarModel extends BaseModel {
  @Column()
  brand: string
}

@Entity()
@TableInheritance({
  column: {
    name: 'type',
    type: 'varchar',
  },
})
export class SingleBaseModel {
  @PrimaryGeneratedColumn()
  id: number

  @CreateDateColumn()
  createdAt: Date

  @UpdateDateColumn()
  updateat: Date
}

@ChildEntity()
export class ComputerModel extends SingleBaseModel {
  @Column()
  brand: string
}

@ChildEntity()
export class AirplaneModel extends SingleBaseModel {
  @Column()
  country: string
}
```

ë§ˆì°¬ê°€ì§€ë¡œ `app.module.ts`ì— ìƒì„±í•œ ëª¨ë“ˆì„ ì¶”ê°€í•œë‹¤.

```ts app.module.ts
@Module({
  imports: [
    TypeOrmModule.forFeature([UserModel]),
    TypeOrmModule.forRoot({
      // ë°ì´í„°ë² ì´ìŠ¤ íƒ€ì…
      type: 'postgres',
      host: '127.0.0.1',
      port: 5808,
      username: 'postgres',
      password: 'postgres',
      database: 'typeormstudy',
      // entitiesí´ë”ì— ì‘ì„±í•œ Model ê°€ì ¸ì˜¤ê¸°
      entities: [
        UserModel,
        StudentModel, //
        TeacherModel,
        BookModel,
        CarModel,
        SingleBaseModel,
        ComputerModel,
        AirplaneModel,
      ],
      synchronize: true,
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

DBì— ë“¤ì–´ê°„ ì»¬ëŸ¼ëª…ì„ í™•ì¸í•´ë³´ë©´,
ìì‹ ì»¬ëŸ¼ì´ ë“¤ì–´ê°„ single_base_model í•˜ë‚˜ë§Œ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

---

## 7. Relationship ì´ë¡ 

- cf. [ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ (ê´€ê³„ ì¢…ë¥˜ 1:1 / 1:M / N:M )](https://hanamon.kr/%EA%B4%80%EA%B3%84%ED%98%95-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4-%EC%84%A4%EA%B3%84-%EA%B4%80%EA%B3%84-%EC%A2%85%EB%A5%98/)

TypeORMì´ ì œê³µí•˜ëŠ” 4ê°€ì§€ Relationship

|     ê´€ê³„      | ì„¤ëª…                                                            |
| :-----------: | --------------------------------------------------------------- |
|  `@OneToOne`  | A í…Œì´ë¸”ì˜ Row í•˜ë‚˜ì™€ B í…Œì´ë¸”ì˜ Row í•˜ë‚˜ê°€ ì—°ê²°ë˜ëŠ” ê´€ê³„       |
| `@ManyToOne`  | A í…Œì´ë¸”ì˜ Row ì—¬ëŸ¬ ê°œì™€ B í…Œì´ë¸”ì˜ Row í•˜ë‚˜ê°€ ì—°ê²°ë˜ëŠ” ê´€ê³„    |
| `@OneToMany`  | A í…Œì´ë¸”ì˜ Row í•˜ë‚˜ì™€ B í…Œì´ë¸”ì˜ Row ì—¬ëŸ¬ê°œê°€ ì—°ê²°ë˜ëŠ” ê´€ê³„     |
| `@ManyToMany` | A í…Œì´ë¸”ì˜ Row ì—¬ëŸ¬ ê°œì™€ B í…Œì´ë¸”ì˜ Row ì—¬ëŸ¬ ê°œê°€ ì—°ê²°ë˜ëŠ” ê´€ê³„ |

---

### 7.1 Relationship Annotation ì ìš©

- ì²«ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì—ëŠ” íƒ€ì…ì„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ë¥¼ ì…ë ¥í•œë‹¤. (Class Transformer Typeê³¼ ê°™ì€ ê°œë…)
- ë‘ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì—ëŠ” ì²«ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì— ì…ë ¥í•œ í´ë˜ìŠ¤ì˜ ì¹¼ëŸ¼ì¤‘ í•˜ë‚˜ë¥¼ ì…ë ¥í•œë‹¤. ì´ ì¹¼ëŸ¼ì€ ì„œë¡œ ê´€ë ¨ì§€ì„ í”„ë¡œí¼í‹°ì—¬ì•¼í•œë‹¤
- e.g. ManyToOne ê´€ê³„ì´ë‹ˆ photo í…Œì´ë¸”ì— user_id ì¹¼ëŸ¼ì´ ìƒì„±ë˜ë©° user í…Œì´ë¸”ê³¼ ê´€ê³„ê°€ í˜•ì„±ëœë‹¤
- íŠ¹ì • photoì™€ ê´€ë ¨ìˆëŠ” userëŠ” photo.userë¡œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆê³  userì™€ ê´€ë ¨ìˆëŠ” photoë“¤ì€ user.photosë¡œ ë¶ˆëŸ¬ ì˜¬ ìˆ˜ ìˆë‹¤

```ts
@Entity()
export class Photo {
  @PrimaryGeneratedColumn()
  id: number

  @Column()
  url: string

  // ì²«ë²ˆì§¸ íŒŒë¼ë¯¸í„° : íƒ€ì…ì„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
  // ë‘ë²ˆì§¸ íŒŒë¼ë¯¸í„° : ì²«ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì— ì…ë ¥í•œ í´ë˜ìŠ¤ì˜ ì¹¼ëŸ¼ì¤‘ í•˜ë‚˜ë¥¼ ì…ë ¥
  @ManyToOne(() => User, (user) => user.photos)
  user: User
}
```

```ts
@Entity()
export class User {
  @PrimaryGeneratedColumn()
  id: number

  @Column()
  name: string

  @OneToMany(() => Photo, (photo) => photo.user)
  photos: Photo[]
}
```

---

### 7.2 ManyToOne & OneToMany ê´€ê³„

- photo í…Œì´ë¸”ì—ëŠ” user_id ì¹¼ëŸ¼ì´ ìë™ìœ¼ë¡œ ìƒê¸´ë‹¤. ë„¤ì´ë° íŒ¨í„´ì€ `{ìƒëŒ€ í…Œì´ë¸” ì´ë¦„}_id`
- user_idëŠ” user í…Œì´ë¸”ì˜ id ì¹¼ëŸ¼ì„ Foreign Keyë¡œ ë ˆí¼ëŸ°ìŠ¤í•œë‹¤
- user í…Œì´ë¸”ì€ ì¶”ê°€ë¡œ ì¹¼ëŸ¼ì´ ìƒì„±ë˜ì§€ ì•ŠëŠ”ë‹¤.
  - ì›ë˜ ManyToOne ë˜ëŠ” OneToMany ê´€ê³„ëŠ” Foreign Key ë ˆí¼ëŸ°ìŠ¤ë¥¼ ë“¤ê³ ìˆëŠ” í…Œì´ë¸”ì´ Many ì…ì¥ì´ë‹¤

| Photo í…Œì´ë¸” |         |                            |
| :----------: | :-----: | -------------------------- |
|      id      |   int   | PRIMARY KEY AUTO_INCREMENT |
|     url      | varchar |                            |
|   user_id    | varchar | FOREIGN KEY                |

| User í…Œì´ë¸” |         |                            |
| :---------: | :-----: | -------------------------- |
|     id      |   int   | PRIMARY KEY AUTO_INCREMENT |
|    name     | varchar |                            |

---

### 7.3 OneToOne ê´€ê³„

- OneToOne Relationshipë„ ë§ˆì°¬ê°€ì§€ë¡œ Annotationì„ ì›í•˜ëŠ” í”„ë¡œí¼í‹°ì— ì •ì˜í•´ì£¼ë©´ ëœë‹¤
- ManyToOneì€ ìƒëŒ€ì˜ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ê°–ëŠ” í…Œì´ë¸”ì´ ëª…í™•í•˜ë‹¤
- OneToOneì€ ë‘ í…Œì´ë¸” ëˆ„ê°€ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ë“¤ê³  ìˆì–´ë„ ìƒê´€ì´ ì—†ê¸° ë•Œë¬¸ì— ì–´ë–¤ í…Œì´ë¸”ì´ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ë“¤ê³  ìˆì„ì§€ ëª…ì‹œí•´ì•¼ í•œë‹¤
- `@JoinTable Annotation`ì„ ì‚¬ìš©í•´ì„œ ì–´ë–¤ í”„ë¡œí¼í‹°ê°€ ë ˆí¼ëŸ°ìŠ¤ ë“¤ê³  ìˆì„ì§€ ì •í•´ ì¤„ ìˆ˜ ìˆë‹¤
- `@JoinTable`ì€ ê¼­ í•œìª½ì—ë§Œ ì ìš©í•´ì•¼í•œë‹¤. ë‘˜ ëª¨ë‘ ì ìš©í•˜ëŠ”ê±´ ê°€ëŠ¥í•˜ê³  ì˜ë¯¸ë„ ì—†ë‹¤

```ts
@Entity()
export class Profile {
  @PrimaryGeneratedColumn()
  id: number

  @Column()
  gender: string

  @Column()
  photos: string

  @OneToOne(() => User, (user) => user.profile)
  user: User
}
```

```ts
@Entity()
export class User {
  @PrimaryGeneratedColumn()
  id: number

  @Column()
  name: string

  @OneToOne(() => Profile)
  @JoinColumn()
  profile: Profile
}
```

---

### 7.4 ManyToMany ê´€ê³„

- ManyToMany Relationshipë„ OneToOne Relationshipê³¼ ë§ˆì°¬ê°€ì§€ë¡œ @JoinTable Annotationì„ í•œìª½ì— ì ìš© í•´ì¤˜ì•¼í•œë‹¤
- ì¤‘ê°„ í…Œì´ë¸”ì´ ìƒì„±ë ë•Œ @JoinTableì´ ì ìš©ëœ í…Œì´ë¸” ì´ë¦„ì´ ë¨¼ì € ìœ„ì¹˜í•˜ê²Œëœë‹¤.
- ManyToMany Annotationì„ ì‚¬ìš©í•˜ë©´ ìë™ìœ¼ë¡œ ì¤‘ê°„ í…Œì´ë¸”ì´ ìƒì„±ëœë‹¤
- ì¤‘ê°„ í…Œì´ë¸”ì˜ ì¹¼ëŸ¼ì€ ê°ê° ë ˆí¼ëŸ°ìŠ¤ í…Œì´ë¸”ì˜ `{í…Œì´ë¸” ì´ë¦„}_id`ë¡œ ì •ì˜ëœë‹¤

```ts
@Entity()
export class Category {
  @PrimaryGeneratedColumn()
  id: number

  @Column()
  name: string

  @ManyToMany(() => Question)
  questions: Question[]
}
```

```ts
@Entity()
export class Question {
  @PrimaryGeneratedColumn()
  id: number

  @Column()
  title: string

  @Column()
  text: string

  @ManyToMany(() => Category)
  @JoinTable()
  categories: Category[]
}
```

---

## 8. 1:1 ê´€ê³„ ì‘ì—…

`src/entity/profile.entity.ts` íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts profile.entity.ts
import { Column, Entity, JoinColumn, OneToOne, PrimaryGeneratedColumn } from 'typeorm'
import { UserModel } from './user.entity'

@Entity()
export class ProfileModel {
  @PrimaryGeneratedColumn()
  id: number

  // UserModelì— userì˜ profile ì»¬ëŸ¼ê³¼ 1:1 ì—°ê²°
  @OneToOne(() => UserModel, (user) => user.profile)
  // ìƒëŒ€ë°© í…Œì´ë¸”ì˜ idë¥¼ ê°€ì§€ê³  ìˆê¸°(ë§Œì•½ ìƒëŒ€ë°©ì´ ê°–ê³ ìˆìœ¼ë©´ ìƒëŒ€ë°©ì´ ì´ í…Œì´ë¸” idë¥¼ ê°€ì§)
  @JoinColumn()
  user: UserModel

  @Column()
  profileImg: string
}
```

ì—°ê²°í•  ëª¨ë¸(`user.entity.ts`)ì— 1:1ë¡œ ì—°ê²°í•  ëª¨ë¸ì„ ì¶”ê°€í•œë‹¤.

```ts user.entity.ts
// ìƒëµ
// ProfileModelì— profileì˜ user ì»¬ëŸ¼ê³¼ 1:1 ì—°ê²°
@OneToOne(() => ProfileModel, profile => profile.user)
profile: ProfileModel
```

`app.module.ts`ì— ìƒì„±í•œ ëª¨ë“ˆ(`ProfileModel`)ì„ ì¶”ê°€í•œë‹¤.

```ts app.module.ts
@Module({
  imports: [
    // ProfileModel ì¶”ê°€
    TypeOrmModule.forFeature([UserModel, ProfileModel]),
    TypeOrmModule.forRoot({
      // ìƒëµ
      // entitiesí´ë”ì— ì‘ì„±í•œ Model ê°€ì ¸ì˜¤ê¸°
      entities: [
        // ìƒëµ
        ProfileModel,
      ],
      synchronize: true,
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
```

user ì—”í‹°í‹°ì˜ titleì„ ì§€ìš°ê³  ëŒ€ì‹ , email ì»¬ëŸ¼ì„ ì¶”ê°€í•œë‹¤.
ê¸°ì¡´ ë°ì´í„°ê°€ ì €ì¥ë˜ì–´ìˆëŠ” ê³³(postgres-data)ì„ ì§€ì› ë‹¤ê°€ ë‹¤ì‹œ ìƒì„±í•œë‹¤.(`docker-compose up`)

```ts user.entity.ts
// user.entity.ts
// title: stringì€ ì£¼ì„ì²˜ë¦¬
@Column()
email: string
```

app ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•œë‹¤.

```ts app.controller.ts
// ìƒëµ
@Controller()
export class AppController {
  constructor(
    @InjectRepository(UserModel)
    private readonly userRepository: Repository<UserModel>,
    @InjectRepository(ProfileModel)
    private readonly profileRepository: Repository<ProfileModel>
  ) {}

  @Post('users')
  postUser() {
    return this.userRepository.save({})
  }

  @Get('users')
  getUsers() {
    return this.userRepository.find({
      // ì—°ë™ëœ ë°ì´í„° ì»¬ëŸ¼(profile)ë„ ê°€ì ¸ì˜¤ê¸°
      relations: {
        profile: true,
      },
    })
  }

  @Patch('users/:id')
  async patchUser(@Param('id') id: string) {
    const user = await this.userRepository.findOne({
      where: { id: parseInt(id) },
    })

    return this.userRepository.save({
      ...user,
    })
  }

  @Post('user/profile')
  async createUserAndProfile() {
    const user = await this.userRepository.save({
      email: 'asd@gmail.ai',
    })
    const profile = await this.profileRepository.save({
      profileImg: 'asdf.png',
      user,
    })
    return user
  }
}
```

---

## 9. M:1 & 1:M ê´€ê³„ êµ¬í˜„

`src/entity/post.entity.ts` íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts post.entity.ts
import { Column, Entity, ManyToOne, PrimaryGeneratedColumn } from 'typeorm'
import { UserModel } from './user.entity'

@Entity()
export class PostModel {
  @PrimaryGeneratedColumn()
  id: number

  // 1:M ê´€ê³„ì´ë‹ˆ postsë¡œ ë³µìˆ˜í˜•ìœ¼ë¡œ ì„ ì–¸
  @ManyToOne(() => UserModel, (user) => user.posts)
  author: UserModel

  @Column()
  title: string
}
```

í…Œì´ë¸”ì´ ì–´ëŠ ì§€ì ì„ ë°”ë¼ë³´ëƒì— ë”°ë¼ M:1ì´ë‚˜ 1:Mì´ ëœë‹¤.

```ts user.entity.ts
// user.entity.ts ìƒëµ
@OneToMany(() => PostModel, post => post.author)
posts: PostModel[]
```

`app.module.ts`ì— ìƒì„±í•œ ëª¨ë“ˆ(`PostModel`)ì„ ì¶”ê°€í•œë‹¤.

```ts app.module.ts
@Module({
  imports: [
    TypeOrmModule.forFeature([
      UserModel,
      ProfileModel,
      PostModel, // ì¶”ê°€
    ]),
    TypeOrmModule.forRoot({
      // ìƒëµ
      // entitiesí´ë”ì— ì‘ì„±í•œ Model ê°€ì ¸ì˜¤ê¸°
      entities: [
        // ìƒëµ
        PostModel,
      ],
      synchronize: true,
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
```

í™•ì¸ìš© apië¥¼ `app.controller.ts`ì— ë§Œë“¤ê³  í¬ìŠ¤íŠ¸ë§¨ì—ì„œ í™•ì¸í•´ë³´ì„¸ìš”.

```ts app.controller.ts
// ìƒëµ

@Controller()
export class AppController {
  constructor(
    @InjectRepository(UserModel)
    private readonly userRepository: Repository<UserModel>,
    @InjectRepository(ProfileModel)
    private readonly profileRepository: Repository<ProfileModel>,
    @InjectRepository(PostModel)
    private readonly postRepository: Repository<PostModel>
  ) {}

  // ìƒëµ
  @Get('users')
  getUsers() {
    return this.userRepository.find({
      relations: {
        profile: true,
        posts: true, // ì¶”ê°€
      },
    })
  }

  @Post('user/post')
  async createUserAndPost() {
    const user = await this.userRepository.save({
      email: 'postuser@gmail.ai',
    })
    await this.postRepository.save({
      author: user,
      title: 'post 1',
    })
    await this.postRepository.save({
      author: user,
      title: 'post 2',
    })

    return user
  }
}
```

---

## 10. M : M ê´€ê³„ êµ¬í˜„

`src/entity/tag.entity.ts` íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts tag.entity.ts
import { Column, Entity, ManyToMany, PrimaryGeneratedColumn } from 'typeorm'
import { PostModel } from './post.entity'

@Entity()
export class TagModel {
  @PrimaryGeneratedColumn()
  id: number

  // M:M ì—°ê²°ì´ê¸° ë•Œë¬¸ì— ë‘˜ ë‹¤ ë³µìˆ˜ë¡œ ì„ ì–¸
  @ManyToMany(() => PostModel, (post) => post.tags)
  posts: PostModel[]

  @Column()
  name: string
}
```

`post.entity.ts`ì— tagsë¥¼ ë‹¤ëŒ€ë‹¤ ê´€ê³„ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.

```ts post.entity.ts
import { Column, Entity, JoinTable, ManyToMany, ManyToOne, PrimaryGeneratedColumn } from 'typeorm'
import { UserModel } from './user.entity'
import { TagModel } from './tag.entity'

@Entity()
export class PostModel {
  @PrimaryGeneratedColumn()
  id: number

  // 1:M ê´€ê³„ì´ë‹ˆ postsë¡œ ë³µìˆ˜í˜•ìœ¼ë¡œ ì„ ì–¸
  @ManyToOne(() => UserModel, (user) => user.posts)
  author: UserModel

  // M:M ì—°ê²°ì´ê¸° ë•Œë¬¸ì— ë‘˜ ë‹¤ ë³µìˆ˜ë¡œ ì„ ì–¸
  @ManyToMany(() => TagModel, (tag) => tag.posts)
  // M:M ì—°ê²°ì—ì„œ JoinTableì€ ë‘˜ ì¤‘ í•˜ë‚˜ ì•„ë¬´êµ°ë° ì„ ì–¸í•´ì£¼ë©´ ëœë‹¤
  @JoinTable()
  tags: TagModel[]

  @Column()
  title: string
}
```

`app.module.ts`ì— ìƒì„±í•œ ëª¨ë“ˆ(`TagModel`)ì„ ì¶”ê°€í•œë‹¤.

```ts app.module.ts
// ìƒëµ
@Module({
  imports: [
    TypeOrmModule.forFeature([
      UserModel,
      ProfileModel, //
      PostModel,
      TagModel,
    ]),
    TypeOrmModule.forRoot({
      // ìƒëµ
      // entitiesí´ë”ì— ì‘ì„±í•œ Model ê°€ì ¸ì˜¤ê¸°
      entities: [
        // ìƒëµ
        TagModel,
      ],
      synchronize: true,
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

app ì»¨íŠ¸ë¡¤ëŸ¬ì— tag ìš”ì²­ì„ ì¶”ê°€í•œë‹¤.

```ts app.controller.ts
// ìƒëµ
@Controller()
export class AppController {
  constructor(
    @InjectRepository(UserModel)
    private readonly userRepository: Repository<UserModel>,
    @InjectRepository(ProfileModel)
    private readonly profileRepository: Repository<ProfileModel>,
    @InjectRepository(PostModel)
    private readonly postRepository: Repository<PostModel>,
    @InjectRepository(TagModel)
    private readonly tagRepository: Repository<TagModel>
  ) {}

  // ìƒëµ

  @Post('posts/tags')
  async createPostsTags() {
    const post1 = await this.postRepository.save({
      title: 'NestJS ìˆ˜ì—…',
    })

    const post2 = await this.postRepository.save({
      title: 'í”„ë¡œê·¸ë˜ë° ìˆ˜ì—…',
    })

    const tag1 = await this.tagRepository.save({
      name: 'Javascript',
      posts: [post1, post2],
    })

    const tag2 = await this.tagRepository.save({
      name: 'Typescript',
      posts: [post1],
    })

    const post3 = await this.postRepository.save({
      title: 'NextJS ìˆ˜ì—…',
      tags: [tag1, tag2],
    })

    return true
  }

  @Get('posts')
  getPosts() {
    return this.postRepository.find({
      relations: {
        tags: true,
      },
    })
  }

  @Get('tags')
  getTags() {
    return this.tagRepository.find({
      relations: {
        posts: true,
      },
    })
  }
}
```

í¬ìŠ¤íŠ¸ë§¨ìœ¼ë¡œ ìš”ì²­í•´ í™•ì¸í•´ë³´ì„¸ìš”.

---

## 11. Relation Options

postgres-data íŒŒì¼ì„ ì§€ì›Œ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ê³  ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.
`user.entity.ts`ì—ì„œ ê´€ê³„ë¡œ ë„£ì„ ìˆ˜ ìˆëŠ” ì˜µì…˜ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤.

```ts user.entity.ts
// ProfileModelì— profileì˜ user ì»¬ëŸ¼ê³¼ 1:1 ì—°ê²°
@OneToOne(() => ProfileModel, profile => profile.user, {
  // find() ì‹¤í–‰í•  ë•Œë§ˆë‹¤ í•­ìƒ ê°™ì´ ê°€ì ¸ì˜¬ relation ì„¤ì •(ê¸°ë³¸ê°’ false)
  eager: true,
  // ì €ì¥í•  ë–„, relationì„ í•œ ë²ˆì— ê°™ì´ ì €ì¥(ê¸°ë³¸ê°’ false)
  cascade: true,
  // nullì´ ê°€ëŠ¥í•œì§€ ì—¬ë¶€(ê¸°ë³¸ê°’ true)
  nullable: true,
  // ê´€ê³„ë¥¼ ì‚­ì œí–ˆì„ ë–„, ì–´ë–»ê²Œ ì‚­ì œí•  ê²ƒì¸ì§€
  // - NO ACTION : ì•„ë¬´ê²ƒë„ ì•ˆí•¨
  // - CASCADE : ì°¸ì¡°í•˜ëŠ” rowë„ ê°™ì´ ì‚­ì œ
  // - SET NULL : ì°¸ì¡°í•˜ëŠ” rowì—ì„œ ì°¸ì¡° idë¥¼ nullë¡œ ë³€ê²½
  // - set default : ê¸°ë³¸ ì„¸íŒ…ìœ¼ë¡œ ì„¤ì •(í…Œì´ë¸”ì˜ ê¸°ë³¸ ì„¸íŒ…)
  // - RESTRICT : ì°¸ì¡°í•˜ê³  ìˆëŠ” rowê°€ ìˆëŠ” ê²½ìš° ì°¸ì¡°ë‹¹í•˜ëŠ” row ì‚­ì œ ë¶ˆê°€
  onDelete: 'NO ACTION',
})
profile: ProfileModel
```

ê´€ê³„ ì‚­ì œ ì˜µì…˜ í…ŒìŠ¤íŠ¸ìš©ì„ `app.controller.ts`ì— ë„£ì–´ì„œ í™•ì¸í•´ë³¸ë‹¤

```ts app.controller.ts
@Delete('user/profile/:id')
async deleteProfile(@Param('id') id: string) {
  await this.profileRepository.delete(+id)
}
```

---

## 12. FindManyOptions íŒŒë¼ë¯¸í„°

`app.controller.ts`ì—ì„œ find()ì— ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ì˜µì…˜ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤.

```ts app.controller.ts
@Get('users')
getUsers() {
  return this.userRepository.find({
    // ì–´ë–¤ ì†ì„±ì„ ì„ íƒí• ì§€ (ê¸°ë³¸ì€ ëª¨ë“  ì†ì„±ì„ ê°€ì ¸ì˜´)
    // selectë¥¼ ì •ì˜í•˜ë©´, ì •ì˜í•œ ì†ì„±ë§Œ ê°€ì ¸ì˜¨ë‹¤
    select: {
      id: true,
      email: true,
      version: true,
      profile: {
        id: true,
      },
    },
    // í•„í„°ë§í•  ì¡°ê±´ì„ ì…ë ¥í•œë‹¤ ({}ì•ˆì—ì„œëŠ” ì „ë¶€ and ì¡°ê±´ìœ¼ë¡œ í•„í„°ë§)
    where: [
      // idê°€ 3ì´ê±°ë‚˜ or versionì´ 1
      {
        id: 3,
      },
      {
        version: 1,
      },
    ],
    // ------ ë‹¤ë¥¸ ê´€ê³„ë¥¼ í•„í„°ë§í•˜ëŠ” ë²•
    // where: {
    //   profile: {
    //     id: 3,
    //   },
    // },
    // ê´€ê³„ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë²•
    relations: {
      profile: true,
    },
    // ì˜¤ë¦„ì°¨(ASC)-ê¸°ë³¸, ë‚´ë¦¼ì°¨(DESC)
    order: {
      id: 'DESC',
    },
    // ì²˜ìŒ ëª‡ ê°œë¥¼ ì œì™¸í•  ì§€ (ê¸°ë³¸ì€ 0) 1ì´ë©´ 1ê°œ ìŠ¤í‚µ
    skip: 0,
    // ëª‡ ê°œë¥¼ ê°€ì ¸ì˜¬ì§€ (ê¸°ë³¸ê°’ì€ 0, ì „ì²´) 1ì´ë©´ 1ê°œë§Œ ê°€ì ¸ì˜´
    take: 0,
  })
}
```

---

## 13. Typeorm ìœ í‹¸ë¦¬í‹° ë„êµ¬

`app.controller.ts`ì—ì„œ find()ì— ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ìœ í‹¸ë¦¬í‹° ì˜µì…˜ì— ëŒ€í•´ ì•Œì•„ë³´ì.

```ts app.controller.ts
@Post('users')
async postUser() {
  for (let i = 0; i < 100; i++) {
    await this.userRepository.save({
      email: `user-${i}@google.com`,
    })
  }
}

@Get('users')
getUsers() {
  return this.userRepository.find({
    where: {
      // ğŸ“Œ (1) 1ì´ ì•„ë‹Œ ê²½ìš° ê°€ì ¸ì˜¤ê¸°
      id: Not(1),

      // ğŸ“Œ (2) 30 ë¯¸ë§Œì˜ ì ì€ ê²½ìš° ê°€ì ¸ì˜¤ê¸°
      id: LessThan(30),

      // ğŸ“Œ (3) 30 ì´í•˜ì˜ ì ì€ ê²½ìš° ê°€ì ¸ì˜¤ê¸°
      id: LessThanOrEqual(30),

      // ğŸ“Œ (4) 30 ì´ˆê³¼ì˜ ë§ì€ ê²½ìš° ê°€ì ¸ì˜¤ê¸°
      id: MoreThan(30)

      // ğŸ“Œ (5) 30 ì´ìƒì˜ ë§ì€ ê²½ìš° ê°€ì ¸ì˜¤ê¸°
      id: MoreThanOrEqual(30)

      // ğŸ“Œ (6) ê°™ì€ ê²½ìš° ê°€ì ¸ì˜¤ê¸°
      id: Equal(30)

      // ğŸ“Œ (7) ìœ ì‚¬ê°’, %ë¡œ ìœ ì‚¬í•œ ë¬¸ì ì°¾ê¸° (ëŒ€ì†Œë¬¸ì êµ¬ë¶„í•¨)
      email: Like('%0@google%'),

      // ğŸ“Œ (8) ìœ ì‚¬ê°’, %ë¡œ ìœ ì‚¬í•œ ë¬¸ì ì°¾ê¸° (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ì•ˆí•¨)
      email: ILike('%GOOGLE%'),

      // ğŸ“Œ (9) ì‚¬ì´ê°’, 10~15ë²ˆ ì‚¬ì´ê¹Œì§€ì˜ ê°’
      id: Between(10, 15),

      // ğŸ“Œ (10) í•´ë‹¹ë˜ëŠ” ì—¬ëŸ¬ ê°œì˜ ê°’, 1, 3, 5, 7, 99ì˜ id ì°¾ê¸°
      id: In([1, 3, 5, 7, 99]),

      // ğŸ“Œ (11) IDê°€ nullì¸ ê²½ìš° ì°¾ê¸°
      id: IsNull(),
    },
    // ì£¼ì„ ìƒëµ
  })
}
```

ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ê³ , 1~100ê°œì˜ ì„ì˜ì˜ ìœ ì €ë¥¼ ë§Œë“  í›„, ê°ê°ì˜ ìœ í‹¸ë¦¬í‹°ë¥¼ í™•ì¸í•œë‹¤.

---

## 14. Repository

- `Repository`ëŠ” ì§€ì •í•œ Entityì— ëŒ€í•œ CRUD ì¿¼ë¦¬ë¥¼ í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤
- TypeORMì— ì •ì˜ë¼ìˆëŠ” ë©”ì„œë“œë“¤ì„ ì‚¬ìš©í•´ì„œ ì§ì ‘ SQLì„ ì‘ì„±í•˜ì§€ ì•Šë”ë¼ë„ ë°ì´í„° ê´€ë¦¬ë¥¼ í•  ìˆ˜ ìˆë‹¤

```ts
const userRepository = dataSources.getRepository(User)
const user = await userRepository.findOne({ id: 1 })
user.name = 'ë­ì‹œê¸°'
await userRepository.save(user)
```

Repositoryì˜ ì£¼ìš” ê¸°ëŠ¥ë“¤

|     ì£¼ìš” ê¸°ëŠ¥ë“¤      | ì£¼ìš” ë©”ì„œë“œ                                                     |
| :------------------: | --------------------------------------------------------------- |
| Create & Delete ê´€ë ¨ | create(), save(), upsert(), delete(), softDelete(), restore()   |
|     Update ê´€ë ¨      | update(), increment(), decrement()                              |
|      Find ê´€ë ¨       | find(), findAndCount(), findOne(), exists(), preload(), query() |
|  í†µê³„ ê´€ë ¨ ë° ê¸°íƒ€   | count(), sum(), average(), minimum(), maximum(), query()        |

---

### 14.1 create()

- create() ë©”ì„œë“œëŠ” ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ì—­í• ì„ í•œë‹¤
- create()ëŠ” save()ì™€ ë‹¤ë¥´ê²Œ ë°ì´í„°ë² ì´ìŠ¤ì— ë°ì´í„°ë¥¼ ìƒì„±í•˜ì§€ ì•Šê³  "ê°ì²´"ë¥¼ ìƒì„±ë§Œ í•œë‹¤ëŠ”ê±¸ ê¼­ ê¸°ì–µí•˜ì!

```ts
// const user = new User();
const user = repository.create()
const user = repository.create({
  id: 1,
  firstName: 'Timber',
  lastName: 'Saw',
})
```

---

### 14.2 save()

- save() ë©”ì„œë“œì— ì €ì¥í•  Entityë¥¼ ì…ë ¥ í•´ì£¼ë©´ ì €ì¥ í•  ìˆ˜ ìˆë‹¤
- create()ì™€ ë‹¤ë¥´ê²Œ ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ì´ ëœë‹¤.
- ë§Œì•½ì— ì´ë¯¸ Rowê°€ ì¡´ì¬í•œë‹¤ë©´ (primary key ê°’ìœ¼ë¡œ êµ¬ë¶„) ì—…ë°ì´íŠ¸í•œë‹¤. (ì£¼ì˜í•  ê²ƒ!)
- ì—¬ëŸ¬ ê°ì²´ë¥¼ í•œë²ˆì— ì €ì¥ë„ ê°€ëŠ¥í•˜ë‹¤

```ts
await repository.save(user)
await repository.save([category1, category2, category3])
```

---

### 14.3 upsert()

- updateì™€ insertë¥¼ í•©ì¹œê²Œ upsert()ë‹¤
- ë°ì´í„° ìƒì„± ì‹œë„ë¥¼ í•œ í›„ ë§Œì•½ì— ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë°ì´í„°ë¼ë©´ ì—…ë°ì´íŠ¸ë¥¼ ì§„í–‰í•œë‹¤
- save()ì™€ ë‹¤ë¥´ê²Œ upsert()ëŠ” í•˜ë‚˜ì˜ transactionì—ì„œ ì‘ì—…ì´ ì‹¤í–‰ëœë‹¤

```ts
await repository.upsert(
  [
    { externalId: 'abc123', firstName: 'Timber' },
    { externalId: 'bca321', firstName: 'Saw' },
  ],
  ['externalId']
)
/** executes
 * INSERT INTO user
 * VALUES
 *  (externalId: "abc123", firstName: 'Timber'),
 *  (externalId: "bca321", firstName: 'Saw')
 * ON CONFLICT (externalId) DO UPDATE firstName = EXCLUDED.firstName
 */
```

---

### 14.4 delete()

- Rowë¥¼ ì‚­ì œí• ë•Œ ì‚¬ìš©ëœë‹¤
- ëŒ€ì²´ì ìœ¼ë¡œ Primary Keyë¥¼ ì‚¬ìš©í•´ì„œ ì‚­ì œí•œë‹¤
- ì›í•œë‹¤ë©´ findOptionsWhere ì¡°ê±´ìœ¼ë¡œ ì—¬ëŸ¬ ê°’ì„ ì‚­ì œ í•  ìˆ˜ë„ ìˆë‹¤.

```ts
await repository.delete(1)
await repository.delete([1, 2, 3])
await repository.delete({ firstName: 'Timber' })
```

---

### 14.5 softDelete(), restore()

- softDelete()ëŠ” ë¹„ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤
- restore()ë¥¼ ì‹¤í–‰í•˜ë©´ softDelete() í–ˆë˜ Rowë¥¼ ë³µêµ¬ í•  ìˆ˜ ìˆë‹¤

```ts
await repository.softDelete(1) // ì‚­ì œ
await repository.restore(1) // ë³µêµ¬
```

---

### 14.6 update()

- ì²«ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì— ê²€ìƒ‰ ì¡°ê±´ì„ ì…ë ¥í•´ì¤€ë‹¤
- ë‘ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì— ë³€ê²½ í•„ë“œë¥¼ ì…ë ¥í•´ì¤€ë‹¤

```ts
// UPDATE user
// SET category = ADULT
// WHERE age = 18
await repository.update({ age: 18 }, { category: 'ADULT' })

// UPDATE user
// SET firstName = ë­ì‹œê¸°
// WHERE id = 1
await repository.update(1, { firstName: 'ë­ì‹œê¸°' })
```

---

### 14.7 find(), findOne(), findAndCount()

- `find()` : í•´ë‹¹ë˜ëŠ” Rowë¥¼ ëª¨ë‘ ë°˜í™˜í•œë‹¤
- `findOne()` : í•´ë‹¹ë˜ëŠ” ì²«ë²ˆì§¸ Rowë¥¼ ë°˜í™˜í•œë‹¤. ì—†ì„ê²½ìš° null
- `findAndCount()` : í•´ë‹¹ë˜ëŠ” Rowì™€ ì „ì²´ ê°¯ìˆ˜ë¥¼ ë°˜í™˜í•œë‹¤.

```ts
const rows = await repository.find({
  where: { firstName: 'Timber' },
})
const rows = await repository.findOne({
  where: { firstName: 'Timber' },
})
const rows = await repository.findAndCount({
  where: { firstName: 'Timber' },
})
```

---

#### 14.7.1 FindOptions

```ts
export interface FindOneOptions<Entity = any> {
  select?: FindOneOptionsSelect<Entity> // ë¶ˆëŸ¬ì˜¬ Columnì„ ì§€ì •
  where?: FindOptionsWhere<Entity>[] // í•„í„°ë§í•  ì¡°ê±´ì„ ì„¤ì •
  relations?: FindOptionsRelations<Entity> // ë¶ˆëŸ¬ì˜¬ ê´€ê³„ í…Œì´ë¸”ì„ ì§€ì •
  order?: FindOneOptionsOrder<Entity> // ì •ë ¬ì„ ì§€ì •
  cache?: boolean | number // ìºì‹± ê¸°ê°„ì„ ì§€ì •
}

export interface FindManyOptions<Entity = any> extends FindOneOptions<Entity> {
  skip?: number
  take?: number
}
```

- ëª¨ë“  find ê´€ë ¨ëœ APIëŠ” FindOptionsë¥¼ ì•„ê·œë¨¼íŠ¸ë¡œ ë°›ëŠ”ë‹¤.
- FindOptionsëŠ” ì–´ë–¤ ê°’ë“¤ì„ ë¶ˆëŸ¬ì˜¬ì§€ í•„í„°ë§í•˜ëŠ” ì—­í• ì„ í•œë‹¤.
- FindOptionsì˜ ì •í™•í•œ TS íƒ€ì… ëª…ì¹­ì€ FindOneOptionsì™€ FindManyOptionsë¡œ ì •ì˜ë¼ìˆë‹¤.
- FindManyOptionsëŠ” FindOneOptionsë¥¼ ìƒì†ë°›ê³  `skip`, `take` 2ê°€ì§€ í”„ë¡œí¼í‹°ê°€ ë” ì¡´ì¬í•œë‹¤

---

##### (1) where ì†ì„±

```ts
// ê¸°ë³¸ ì‚¬ìš©ë²•
const users = await userRepository.find({
  where: { isActive: true },
})

// ë‹¤ì¤‘ì¡°ê±´ ì‚¬ìš©ë²•
const users = await userRepository.find({
  where: [
    { firstName: 'John', lastName: 'Doe' },
    { firstName: 'Jane', lastName: 'Smith' },
  ],
})

// ì¤‘ì²© ì‚¬ìš©ë²•
const users = await userRepository.find({
  where: [
    isActive: true,
    profile : { age: MoreThan(25) },
  ],
})
```

---

##### (2) order ì†ì„±

```ts
//  ë‹¨ì¼ ì •ë ¬ ì‚¬ìš©ë²•
const users = await userRrepository.find({
  order: { firstName: 'ASC' },
})

// ë³µìˆ˜ ì •ë ¬ ì‚¬ìš©ë²•
const users = await userRrepository.find({
  order: { lastName: 'ASC', firstName: 'DESC' },
})
```

---

##### (3) relation ì†ì„±

```ts
const users = await userRepository.find({
  relations: ['profile', 'photos'],
})
```

---

##### (4) select ì†ì„±

```ts
const users = await userRepository.find({
  select: ['firstName', 'lastName'],
})
```

---

##### (5) cache ì†ì„±

```ts
// ê¸°ë³¸ ì‚¬ìš©ë²•
const users = await userRepository.find({
  cache: true,
})

// ê¸°ê°„ ì§ì ‘ ì •ì˜
const users = await userRepository.find({
  cache: 60000, // 60ì´ˆ
})
```

---

#### 14.7.2 FindManyOptions

```ts
const users = await userRepository.find({
  skip: 10, // ì²˜ìŒ 10ê°œë¥¼ ì œì™¸í•˜ê³  ê°€ì ¸ì˜¨ë‹¤
  take: 5, // ì²˜ìŒ 5ê°œë§Œ ê°€ì ¸ì˜¨ë‹¤
})
```

- `Skip` : ì •ë ¬ í›„ ìŠ¤í‚µí•  ë°ì´í„° ê°¯ìˆ˜ë¥¼ ì •í•  ìˆ˜ ìˆë‹¤
  - ê¸°ë³¸ê°’ì€ 0, 1ì´ë©´ 1ê°œë¥¼ ì œì™¸í•˜ê³  ê°€ì ¸ì˜¨ë‹¤
- `Take` : ì²˜ìŒ ëª‡ê°œì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ì§€ ì •í•  ìˆ˜ ìˆë‹¤
  - ê¸°ë³¸ê°’ì€ 0, 1ì´ë©´ 1ê°œë§Œ ê°€ì ¸ì˜¨ë‹¤

---

#### 14.7.3 Advanced Options

| ì£¼ìš” ì˜¤í¼ë ˆì´í„° | ì£¼ìš” ë©”ì„œë“œ                                                                     |
| :-------------: | ------------------------------------------------------------------------------- |
|      ë¹„êµ       | Equal, Not, LessThan, LessThanOrEqual, MoreThan, <br />MoreThanOrEqual, Between |
|    íŒ¨í„´ë§¤ì¹­     | Like, ILike                                                                     |
|      ì§‘í•©       | In, ArrayContains, ArrayContainedBy, ArrayOverlap                               |
|      ê¸°íƒ€       | IsNull, Or, And, Raw                                                            |

---

##### (1) Equal ì˜¤í¼ë ˆì´í„°

```ts
// Equal : ê°™ì€ ê°’ì„ ì°¾ì„ë•Œ ì‚¬ìš©
const users = await userRepository.find({
  where: { age: Equal(25) },
})
```

---

##### (2) Not ì˜¤í¼ë ˆì´í„°

```ts
// Not : ì•„ë‹Œ ê°’ì„ ì°¾ì„ë•Œ ì‚¬ìš©
const users = await userRepository.find({
  where: { age: Not(25) },
})
```

---

##### (3) LessThan & LessThanOrEqual ì˜¤í¼ë ˆì´í„°

```ts
// ì ì€ê°’ & ì ê±°ë‚˜ ê°™ì€ ê°’ì„ ì°¾ì„ë•Œ ì‚¬ìš©
const users = await userRepository.find({
  where: { age: LessThan(30) },
})
const users = await userRepository.find({
  where: { age: LessThanOrEqual(30) },
})
```

---

##### (4) MoreThan & MoreThanOrEqual ì˜¤í¼ë ˆì´í„°

```ts
// ë” í°ê°’ & í¬ê±°ë‚˜ ê°™ì€ ê°’ì„ ì°¾ì„ë•Œ ì‚¬ìš©
const users = await userRepository.find({
  where: { age: MoreThan(20) },
})
const users = await userRepository.find({
  where: { age: MoreThanOrEqual(20) },
})
```

---

##### (5) Between

```ts
// ì‚¬ì´ ê°’ì„ ì°¾ì„ë•Œ ì‚¬ìš©
const users = await userRepository.find({
  where: { age: Between(20, 30) },
})
```

---

##### (6) Like & ILike

```ts
// ìŠ¤íŠ¸ë§ì— ë§¤ì¹­ë˜ëŠ” ê°’ì„ ì°¾ì„ë•Œ ì‚¬ìš©í•œë‹¤. LikeëŠ” ëŒ€ì†Œë¬¸ì êµ¬ë¶„í• ë•Œ, ILikeëŠ” ëŒ€ì†Œë¬¸ì êµ¬ë¶„í•˜ì§€ ì•Šì„ë•Œ ì‚¬ìš©
const users = await userRepository.find({
  where: { firstName: Like('Co%') },
})
const users = await userRepository.find({
  where: { firstName: ILike('co%') },
})
```

---

##### (7) In

```ts
// ë¦¬ìŠ¤íŠ¸ì— ë§¤ì¹­ë˜ëŠ” ê°’ì„ ì°¾ëŠ”ë‹¤
const users = await userRepository.find({
  where: { age: In([20, 25, 30]) },
})
```

---

##### (8) ArrayContains & ArrayContainedBy & ArrayOverlap

```ts
// ArrayContains : ì—”í‹°í‹° ë¦¬ìŠ¤íŠ¸ ê°’ì´ íƒ€ê²Ÿ ë¦¬ìŠ¤íŠ¸ì™€ ì™„ì „ ë˜‘ê°™ì€ ê²½ìš°ë¥¼ í•„í„°ë§
const users = await userRepository.find({
  where: { roles: ArrayContains(['admin']) },
})

// ArrayContainedBy : ì—”í‹°í‹° ë¦¬ìŠ¤íŠ¸ ê°’ì´ íƒ€ê²Ÿ ë¦¬ìŠ¤íŠ¸ ì•ˆì— ëª¨ë‘ í¬í•¨ë˜ëŠ” ê²½ìš°ë¥¼ í•„í„°ë§
const users = await userRepository.find({
  where: { roles: ArrayContainedBy(['admin', 'user']) },
})

// ArrayOverlap : ì—”í‹°í‹° ë¦¬ìŠ¤íŠ¸ ê°’ì´ í•˜ë‚˜ë¼ë„ íƒ€ê²Ÿ ë¦¬ìŠ¤íŠ¸ì™€ ê²¹ì¹˜ëŠ” ê²½ìš°ë¥¼ í•„í„°ë§
const users = await userRepository.find({
  where: { roles: ArrayOverlap(['admin', 'guest']) },
})
```

(8-1) ArrayContains

```ts
// Record 1
{
  id: 1,
  tags: ['admin', 'user', 'manager'],
}
// Record 2
{
  id: 2,
  roles: ['user', 'guest'],
}
```

```ts
const users = await getRepository(User).find({
  // Record 2ì˜ Tagsê°€ ì™„ì „íˆ ê°™ìœ¼ë‹ˆ Record 2ë§Œ ë°˜í™˜
  tags: ArrayContains(['user', 'guest']),
})
```

(8-2) ArrayContainedBy

```ts
// Record 1
{
  id: 1,
  tags: ['admin', 'user', 'manager'],
}
// Record 2
{
  id: 2,
  roles: ['user', 'guest'],
}
```

```ts
const users = await getRepository(User).find({
  // Record 1ê³¼ Record 2ì˜ Tagsë“¤ì´ ëª¨ë‘ í•„í„° ë¦¬ìŠ¤íŠ¸ì— í¬í•¨ë˜ê¸° ë•Œë¬¸ì— ë‘˜ ë‹¤ ë°˜í™˜
  tags: ArrayContainedBy(['admin', 'user', 'guest', 'manager']),
})
```

(8-3) ArrayOverlap

```ts
// Record 1
{
  id: 1,
  tags: ['admin', 'user', 'manager'],
}
// Record 2
{
  id: 2,
  roles: ['user', 'guest'],
}
```

```ts
const users = await getRepository(User).find({
  // Record 1ì˜ Tagsì™€ Record 2ì˜ Tagsê°€ ëª¨ë‘ í•„í„° ë¦¬ìŠ¤íŠ¸ì™€ ê²¹ì¹˜ëŠ” ë¶€ë¶„ì´ ìˆê¸° ë•Œë¬¸ì— ë‘˜ ë‹¤ ë°˜í™˜
  tags: ArrayOverlap(['guest', 'admin']),
})
```

---

##### (9) IsNull

```ts
const users = await userRepository.find({
  where: { age: IsNull() }, // ageê°€ nullì¸ ê²½ìš°
})
```

---

##### (10) Or

```ts
const loadedPosts = await dataSource.getRepository(Post).findBy({
  // 2ê°œì˜ ì¡°ê±´ ì¤‘ í•˜ë‚˜ë¼ë„ ë§Œì¡±í•˜ë©´ ë°˜í™˜
  title: Or(Equal('About #2'), ILike('About%')),
})
```

---

##### (11) And

```ts
const loadedPosts = await dataSource.getRepository(Post).findBy({
  // 2ê°œì˜ ì¡°ê±´ ëª¨ë‘ ë§Œì¡±í•˜ë©´ ë°˜í™˜
  title: And(Not(Equal('About #2'), ILike('About%'))),
})
```

---

#### 14.7.4 ë³µì¡í•œ ë ˆí¬ì§€í† ë¦¬ ì¿¼ë¦¬

```ts
const users = await userRepository.find({
  where: [
    { isActive: true, age: MoreThan(25) },
    { firstName: 'John', age: LessThan(50) },
  ],
  order: { fistName: 'ASC' },
  relations: ['profile'],
  select: ['firstName', 'lastName'],
  skip: 0,
  take: 10,
  cache: true,
  loadRelationIds: true,
  loadEagerRelations: false,
  withDeleted: false,
})
```

---

### 14.7 exists()

- `exists()` : íŠ¹ì • ì¡°ê±´ì˜ Rowê°€ ì¡´ì¬í•˜ëŠ”ì§€ boolean ê°’ì„ ë°˜í™˜ ë°›ì„ ìˆ˜ ìˆë‹¤

```ts
const exists = await repository.exists({
  where: {
    firstName: 'Timber',
  },
})
```

---

### 14.8 preload()

- preload()ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ëœ ê°’ì„ Primary Key ê¸°ì¤€ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ê³  ì…ë ¥ëœ ê°ì²´ì˜ ê°’ìœ¼ë¡œ í”„ë¡œí¼í‹°ë¥¼ ë®ì–´ì“´ë‹¤
- ë®ì–´ì“°ëŠ” ê³¼ì •ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— ì—…ë°ì´íŠ¸ ìš”ì²­ì´ ë³´ë‚´ì§€ì§€ëŠ” ì•ŠëŠ”ë‹¤

```ts
const partiaIUser = {
  id: 1,
  firstName: 'Timber',
  profile: { id: 1 },
}
const user = await repository.preload(partiaIUser)
```

---

## 15. ê°ì¢… í†µê³„

- `count()` : í•´ë‹¹ë˜ëŠ” ê°œìˆ˜ë¥¼ ë°˜í™˜í•œë‹¤
- `sum()` : í•´ë‹¹ë˜ëŠ” ì†ì„±ë“¤ì˜ ê°’ì„ ì „ë¶€ í•©ì¹œ ê°’ì„ ë°˜í™˜í•œë‹¤
- `average()` : í•´ë‹¹ë˜ëŠ” ì†ì„±ë“¤ì˜ í‰ê· ê°’ì„ ë°˜í™˜í•œë‹¤
- `minimum()` : í•´ë‹¹ë˜ëŠ” ì†ì„±ë“¤ì˜ ìµœì†Œê°’ì„ ë°˜í™˜í•œë‹¤
- `maximum()` : í•´ë‹¹ë˜ëŠ” ì†ì„±ë“¤ì˜ ìµœëŒ€ê°’ì„ ë°˜í™˜í•œë‹¤

```ts
// firstNameì´ Timberì¸ ê°’ë“¤ì˜ ê°œìˆ˜
const count = await repository.count({
  where: { firstName: 'Timber' },
})
// age ì»¬ëŸ¼ì˜ firstNameì´ Timberì¸ ê°’ë“¤ì˜ í•©ê³„
const sum = await repository.sum('age', {
  firstName: 'Timber',
})
// age ì»¬ëŸ¼ì˜ firstNameì´ Timberì¸ ê°’ë“¤ì˜ í‰ê· ê°’
const average = await repository.average('age', {
  firstName: 'Timber',
})
// age ì»¬ëŸ¼ì˜ firstNameì´ Timberì¸ ê°’ë“¤ì˜ ìµœì†Œê°’
const minimum = await repository.minimum('age', {
  firstName: 'Timber',
})
// age ì»¬ëŸ¼ì˜ firstNameì´ Timberì¸ ê°’ë“¤ì˜ ìµœëŒ€ê°’
const maximum = await repository.maximum('age', {
  firstName: 'Timber',
})
```

---

## 16. Repository ì‹¤ìŠµ

`user.entity.ts`ì— count ì»¬ëŸ¼ì„ ì¶”ê°€í•œë‹¤.

```ts
@Column({ default: 0 })
count: number
```

app ì»¨íŠ¸ë¡¤ëŸ¬ì— sample ìš”ì²­ì„ ë§Œë“¤ê³  ì‹¤ìŠµí•œë‹¤.

```ts app.controller.ts
 @Post('sample')
async sample() {
  // ğŸ“Œ (1) ëª¨ë¸ì— í•´ë‹¹ë˜ëŠ” ê°ì²´ ìƒì„± - ì €ì¥ì€ ì•ˆí•¨
  const user1 = await this.userRepository.create({
    email: 'test@gmail.ai',
  })

  // ğŸ“Œ (2) ëª¨ë¸ì— í•´ë‹¹ë˜ëŠ” ê°ì²´ ìƒì„± - DBì— ì €ì¥í•¨
  const user2 = await this.userRepository.save({
    email: 'test@gmail.ai',
  })

  /*** ğŸ“Œ (3) preload
   * ì…ë ¥ëœ ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ DBì— ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³ ,
   * ì¶”ê°€ì…ë ¥ëœ ê°’ìœ¼ë¡œ DBì— ê°€ì ¸ì˜¨ ê°’ë“¤ì„ ëŒ€ì²´í•¨
   * ì €ì¥í•˜ì§€ëŠ” ì•ŠìŒ
   */
  const user3 = await this.userRepository.preload({
    id: 101,
    email: 'testë³€ê²½-ì €ì¥x@gmail.ai',
  })

  // ğŸ“Œ (4) ì‚­ì œí•˜ê¸°
  await this.userRepository.delete(101)

  // ğŸ“Œ (5) ìˆ«ìí˜• ì»¬ëŸ¼ ì¦ê°€ (idê°€ 1ì¸ count ì»¬ëŸ¼ì„ 2ë§Œí¼ ì¦ê°€)
  await this.userRepository.increment(
    { id: 1 }, //
    'count',
    2,
  )

  // ğŸ“Œ (6) ìˆ«ìí˜• ì»¬ëŸ¼ ê°ì†Œ (idê°€ 1ì¸ count ì»¬ëŸ¼ì„ 1ë§Œí¼ ê°ì†Œ)
  await this.userRepository.decrement(
    { id: 1 }, //
    'count',
    1,
  )

  // ğŸ“Œ (7) ê°œìˆ˜ ì¹´ìš´íŒ…í•˜ê¸°
  const count = await this.userRepository.count({
    where: {
      email: ILike('%0%'),
    },
  })

  // ğŸ“Œ (8) sum : ì†ì„±ë“¤ì˜ ê°’ ì „ë¶€ í•©ì¹˜ê¸°
  const sum = await this.userRepository.sum('count', {
    email: ILike('%0%'),
  })

  // ğŸ“Œ (9) average : ì†ì„±ì˜ í‰ê· ê°’ êµ¬í•˜ê¸°
  const average = await this.userRepository.average('count', {
    id: LessThan(4),
  })

  // ğŸ“Œ (10) min : ì†ì„±ì˜ ìµœì†Œê°’ êµ¬í•˜ê¸°
  const min = await this.userRepository.minimum('count', {
    id: LessThan(4),
  })

  // ğŸ“Œ (10) max : ì†ì„±ì˜ ìµœëŒ€ê°’ êµ¬í•˜ê¸°
  const max = await this.userRepository.maximum('count', {
    id: LessThan(4),
  })

  // ğŸ“Œ (11) findì™€ findOneë„ ìˆìŒ(ë§ì´ ë‹¤ë¤˜ìœ¼ë‹ˆ ìƒëµ)
  const userOne = await this.userRepository.findOne({
    where: { id: 3 },
  })

  // ğŸ“Œ (12) 3ê°œì˜ ê°’ì„ ê°€ì ¸ì˜¤ëŠ”ë°, ì „ì²´ í–‰ ê°œìˆ˜ë„ ë°˜í™˜í•´ì¤Œ
  const usersAndCount = await this.userRepository.findAndCount({
    take: 3,
  })

  return usersAndCount
}
```

---

## 17. QueryBuilder

```tsx
const users = await userRepository
  .craeteQueryBuilder('user') // user í…Œì´ë¸”ì„ ê¸°ë°˜ìœ¼ë¡œ QueryBuilder ìƒì„±
  .leftJoinAndSelect('user.profile', 'profile') // user.profile í…Œì´ë¸”ì„ ì¡°ì¸
  .where('user.isActive = :isActive', { isActive: true }) // isActiveê°€ trueì¸ ê°’ë§Œ ê°€ì ¸ì˜¤ê¸°
  // ì‚¬ìš©ë²• : where("ì»¬ëŸ¼ = :ë³€ìˆ˜ëª…", { ë³€ìˆ˜ëª…: ê°’ })
  .orderBy('user.firstName', 'ASC') // firstNameì„ ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
  .skip(10) // ì²˜ìŒ 10ê°œ ì œì™¸í•˜ê³  ê°€ì ¸ì˜¤ê¸°
  .take(5) // ì²˜ìŒ 5ê°œë§Œ ê°€ì ¸ì˜¤ê¸°
  .getMany() // ê²°ê³¼ê°’ì„ ê°€ì ¸ì˜¤ê¸°
```

- ë³µì¡í•˜ì§€ ì•Šì€ ì¼ë°˜ì ì¸ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•  ë•ŒëŠ” Repositoryë¥¼ ì‚¬ìš©í•˜ëŠ”ê²Œ í¸ë¦¬í•˜ë‹¤.
- ì¡°ê¸ˆ ë” ë³µì¡í•œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰ í•´ì•¼í•˜ê±°ë‚˜ ë‹¤ì´ë‚˜ë¯¹í•˜ê²Œ ì¿¼ë¦¬ë¥¼ ë§Œë“¤ì–´ê°€ì•¼ í•  ê²½ìš° Query Builderë¥¼ ì‚¬ìš©í•´ì•¼í•œë‹¤

---

### 17.1 Query Builderì˜ 5ê°€ì§€ ì‹¤í–‰ íƒ€ì… : (1) select

```tsx
const movie = await dataSource
  .createQueryBuilder()
  .select('movie')
  .from(Movie, 'movie') // from(í…Œì´ë¸”ëª…, 'ë³„ì¹­')
  .leftJoinAndSelect('movie.detail', 'detail') // leftJoinAndSelect(í…Œì´ë¸”ëª….ì»¬ëŸ¼ëª…, 'ë³„ì¹­')
  .leftJoinAndSelect('movie.director', 'director')
  .leftJoinAndSelect('movie.genres', 'genres')
  .where('movie.id = :id', { id: 1 }) // where(ì¡°ê±´, { ë³€ìˆ˜ëª…: ê°’ }) - ":id"ëŠ” ë³€ìˆ˜ë¥¼ ì˜ë¯¸
  .getOne() // ê²°ê³¼ê°’ì„ í•˜ë‚˜ë§Œ ê°€ì ¸ì˜¤ê¸°, ì—¬ëŸ¬ ê°œëŠ” getMany()ë¥¼ ì‚¬ìš©
```

---

### 17.2 Query Builderì˜ 5ê°€ì§€ ì‹¤í–‰ íƒ€ì… : (2) insert

```tsx
await dataSource
  .createQueryBuilder()
  .insert()
  .into(Movie) // dataë¥¼ ë„£ì„ í…Œì´ë¸”
  .values([
    {
      title: 'New Movie', //
      genre: 'Action',
      director: director,
      genres: genres,
    },
  ])
  .execute() // ì‹¤í–‰
```

---

### 17.3 Query Builderì˜ 5ê°€ì§€ ì‹¤í–‰ íƒ€ì… : (3) update

```tsx
await dataSource
  .createQueryBuilder()
  .update(Movie)
  .set({ title: 'Updated Movie', genre: 'Drama' })
  .where('id = :id', { id: 1 })
  .execute()
```

---

### 17.4 Query Builderì˜ 5ê°€ì§€ ì‹¤í–‰ íƒ€ì… : (4) delete

```tsx
await dataSource
  .createQueryBuilder()
  .delete()
  .from(Movie)
  .where('id = :id', { id: 1 }) // idê°€ 1ì¸ ê°’ì„ ì‚­ì œ
  .execute()
```

---

### 17.5 Query Builderì˜ 5ê°€ì§€ ì‹¤í–‰ íƒ€ì… : (5) relations

```tsx
const genres = await dataSource
  .createQueryBuilder()
  .relation(Movie, 'genres') // Movie í…Œì´ë¸”ì˜ genres ì»¬ëŸ¼ì„ ê¸°ë°˜ìœ¼ë¡œ
  .of(1) // Movie idê°€ 1ì¸ ê°’ì„ ê°€ì ¸ì˜¤ê¸°
  .loadMany() // ê²°ê³¼ê°’ì„ ê°€ì ¸ì˜¤ê¸°
```

---

### 17.6 getOne(), getMany(), select()

```tsx
// ë‹¨ì¼ Rowë§Œ ê°€ì ¸ì˜¬ ë•Œ
const uesrs = await connection
  .getRepository(User) // User í…Œì´ë¸”ì„ ê¸°ë°˜ìœ¼ë¡œ Repository ìƒì„±
  .createQueryBuilder('user') // createQueryBuilder('ë³„ì¹­')
  .select(['user.id', 'user.firstName', 'user.lastName'])
  .getOne()

// ë³µìˆ˜ Rowë§Œ ê°€ì ¸ì˜¬ ë•Œ
const users = await connection
  .getRepository(User)
  .craeteQueryBuilder('user')
  .select(['user.id', 'user.firstName', 'user.lastName'])
  .getMany()
```

---

### 17.7 where()

```tsx
// í•˜ë‚˜ì˜ í•„í„°ë§ ì¡°ê±´ ì ìš©
const users = await connection
  .getRepository(User) // User í…Œì´ë¸”ì„ ê¸°ë°˜ìœ¼ë¡œ Repository ìƒì„±
  .createQueryBuilder('user') // user í…Œì´ë¸”ì„ ê¸°ë°˜ìœ¼ë¡œ QueryBuilder ìƒì„±
  .where('user.isActive = :isActive', { isActive: true })
  .getMany()

// ë‹¤ìˆ˜ì˜ í•„í„°ë§ ì¡°ê±´ ì ìš©
const users = await connection
  .getRepository(User)
  .createQueryBuilder('user')
  .where('user.firstName = :firstName', { firstName: 'Timber' })
  .andWhere('user.lastName = :lastName', { lastName: 'Saw' })
  .getMany()
```

---

### 17.8 orderBy()

```tsx
const users = await connection
  .getRepository(User)
  .createQueryBuilder('user')
  .orderBy('user.lastName', 'ASC') // lastNameì„ ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
  .addOrderBy('user.firstName', 'DESC') // firstNameì„ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
  .getMany()
```

---

### 17.9 skip(), take()

```tsx
const users = await connection
  .getRepository(User)
  .createQueryBuilder('user')
  .skip(10) // ì²˜ìŒ 10ê°œ ì œì™¸í•˜ê³  ê°€ì ¸ì˜¤ê¸°
  .take(5) // ì²˜ìŒ 5ê°œë§Œ ê°€ì ¸ì˜¤ê¸°
  .getMany()
```

---

### 17.10 join()

```tsx
// Inner Join
const users = await connection
  .getRepository(User)
  .createQueryBuilder('user') // createQueryBuilder('ë³„ì¹­')
  .innerJoinAndSelect('user.profile', 'profile') // innerJoinAndSelect(í…Œì´ë¸”ëª….ì»¬ëŸ¼ëª…, 'ë³„ì¹­')
  .getMany()

// Left Join
const users = await connection
  .getRepository(User)
  .createQueryBuilder('user')
  .leftJoinAndSelect('user.photos', 'photos') // leftJoinAndSelect(í…Œì´ë¸”ëª….ì»¬ëŸ¼ëª…, 'ë³„ì¹­')
  .getMany()
```

---

### 17.11 Aggregation(ì§‘ê³„)

```tsx
const userCount = await connection
  .getRepository(User)
  .creawteQueryBuilder('user')
  .select('COUNT(user.id)', 'count') // select('ì§‘ê³„í•¨ìˆ˜(í…Œì´ë¸”ëª….ì»¬ëŸ¼ëª…)', 'ë³„ì¹­')
  .getRawOne()
```

---

### 17.12 Subquery

```tsx
const users = await connection
  .getRepository(User)
  .createQueryBuilder('user')
  .where((qb) => {
    const subQuery = qb
      .subQuery()
      .select('subUser.id')
      .from(User, 'subUser')
      .where('subUser.isActive = :isActive', { isActive: true })
      .getQuery()
    return 'user.id IN ' + subQuery // user.idê°€ subQueryì— í¬í•¨ë˜ëŠ” ê°’ë§Œ ê°€ì ¸ì˜¤ê¸°
  })
  .setParameters('isActive', true)
  .getMany()
```

---

### 17.12 Raw Query

```tsx
const users = await connection
  .getRepository(User)
  .createQueryBuilder()
  .select('user')
  .from(User, 'user')
  .where('user.isActive = :isActive', { isActive: true })
  .getRawMany()
```
