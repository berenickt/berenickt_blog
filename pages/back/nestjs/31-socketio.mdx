---
title: '31-socketIO-ê¸°ë³¸'
date: 2023/12/25
---

## 1. Websocket ì´ë¡ 

- ì±„íŒ… ì„œë¹„ìŠ¤, ì£¼ì‹ ê´€ë ¨ ì„œë¹„ìŠ¤, ê°€ìƒí™”í ì„œë¹„ìŠ¤ ê°™ì€ ê±¸ìƒˆë¡œê³ ì¹¨ì„ í•˜ì§€ ì•Šì•„ë„ ì„œë²„ì—ì„œ ì •ë³´ë¥¼ ë˜ì ¸ì¤€ë‹¤.
- ì›¹ì†Œì¼“ì„ ì‚¬ìš©í•˜ì‹œë©´. ì´ëŸ° ë¦¬ì–¼íƒ€ì„ ì„œë¹„ìŠ¤ë¥¼ ì €í¬ê°€ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.

```
// ************* ê¸°ì¡´ í´ë¼ì´ì–¸íŠ¸-ì„œë²„ êµ¬ì¡°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€ (ìš”ì²­) â”€â”€â”€â”€â”€â”€â”€> â”‚           â”‚
â”‚  í´ë¼ì´ì–¸íŠ¸  â”‚                          â”‚    ì„œë²„    â”‚
â”‚           â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€ (ì‘ë‹µ) â”€â”€â”€â”€â”€â”€â”€â”€ â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- ê¸°ì¡´ì˜ í´ë¼ì´ì–¸íŠ¸-ì„œë²„ êµ¬ì¡°ì˜ ë¬¸ì œì ì€ ë‹¨ì¼ ë°©í–¥ì´ë¼ëŠ” ì ì´ë‹¤.
- ì¦‰, í´ë¼ì´ì–¸íŠ¸ì—ì„œë¶€í„° ìš”ì²­ì„ ë³´ë‚´ì•¼ì§€ë§Œ, ìš”ì²­í•œ ê±°ì— ëŒ€í•œ ì‘ë‹µì„ ë°›ì„ ìˆ˜ ìˆë‹¤.

```
// ************* WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           â”‚ <â”€â”€â”€â”€â”€ (ìš”ì²­, ì‘ë‹µ) â”€â”€â”€â”€â”€> â”‚           â”‚
â”‚  í´ë¼ì´ì–¸íŠ¸  â”‚                          â”‚    ì„œë²„    â”‚
â”‚           â”‚ <â”€â”€â”€â”€â”€ (ìš”ì²­, ì‘ë‹µ) â”€â”€â”€â”€â”€> â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- e.g.) ì±„íŒ…ì€ ëˆ„ê°€ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë©´, ì‚¬ìš©ì ë”°ë¡œ ë­˜ í•˜ì§€ ì•Šì•„ë„(ìš”ì²­í•˜ì§€ ì•Šì•„ë„) ë©”ì‹œì§€ê°€ ì˜¨ë‹¤.
- ì´ê²ƒì´ real-time communicationì´ê³ , ì›¹ì†Œì¼“ì´ í•´ê²°í•´ì¤€ë‹¤.
- ê·¸ë˜ì„œ ì´ì œëŠ” ì–‘ë°©í–¥ìœ¼ë¡œ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ì„ í•  ìˆ˜ê°€ ìˆê²Œ ëœë‹¤.

---

## 2. Socket IO ì´ë¡ 

![bidirectional-communication2](https://socket.io/images/bidirectional-communication2.png)

- ê³µì‹ë¬¸ì„œ : https://socket.io/docs/v4/
- `Socket IO`ëŠ” Websocket í”„ë¡œí† ì½œì„ ì‚¬ìš©í•´ì„œ ë§Œë“ 
  - low-latency(ë‚®ì€ ì§€ì—°ì‹œê°„), bidirectional(ì–‘ë°©í–¥ ì†Œí†µ), event based(ì´ë²¤íŠ¸ ê¸°ë°˜)ìœ¼ë¡œ
  - í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ê°€ í†µì‹ í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ê¸°ëŠ¥ì´ë‹¤.
- ì¦‰, Socket IOëŠ” ê²°êµ­ì— ì›¹ì†Œì¼“ì´ë‹¤.

---

### 2.1 ê¸°ë³¸ì ì¸ í†µì‹ ë²•. emit & on

- `emit` : ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ê²ƒ
- `on` : ë³´ë‚¸ ë©”ì‹œì§€ë¥¼ ë¦¬ìŠ¤ë‹í•˜ëŠ” ê²ƒ

ì„œë²„ ì½”ë“œ

```ts server
import { Server } from 'socket.io'

// Socekt.IO ì„œë²„ ìƒì„±
const io = new Server(3000)

/** ğŸ“Œ on() : í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì— ì—°ê²°ë˜ë©´ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ ì •ì˜
 * on í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ë©´ íŠ¹ì • ì´ë²¤íŠ¸(1ë²ˆì¨° íŒŒë¼ë¯¸í„°)ê°€ ìˆì„ë–„,
 * ì½œë°± í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìœ¼ë©°, (2ë²ˆì¨° íŒŒë¼ë¯¸í„°)
 * í•´ë‹¹ ì½œë°± í•¨ìˆ˜ëŠ” ë©”ì‹œì§€ë¥¼ 1ë²ˆì¨° íŒŒë¼ë¯¸í„°ë¡œ ë°›ëŠ”ë‹¤.
 * connection ì´ë²¤íŠ¸ëŠ” ë¯¸ë¦¬ ì •ì˜ëœ ì´ë²¤íŠ¸ë¡œ "ì—°ê²°ëì„ ë–„" ì‹¤í–‰í•œë‹¤.
 */
io.on('connection', socket => {
  /** ğŸ“Œ emit() : ë©”ì‹œì§€ ë³´ë‚´ê¸°
   * 1ë²ˆ íŒŒë¼ë¯¸í„°, ì´ë²¤íŠ¸ ì´ë¦„
   * 2ë²ˆ~ì´í›„ íŒŒë¼ë¯¸í„°, ë©”ì‹œì§€
   */
  socket.emit('hello_form_server', 'this is message from server')

  socket.on('hello_from_client', message => {
    // 'this is message from clinet'
    console.log(message)
  })
})
```

í´ë¼ì´ì–¸íŠ¸ ì½”ë“œ

```ts client
import { io } from 'socket.io-client'

// ğŸ“Œ (1) Socket.IO ì„œë²„ì— ì—°ê²°
const socket = io('ws://localhost:3000') // wsëŠ” ì›¹ì†Œìº£ì˜ ì•½ì–´

// 'hello_from_clint' ì´ë²¤íŠ¸ë¥¼ ë“£ê³  ìˆëŠ” ì†Œì¼“ì— ë©”ì‹œì§€ ë³´ë‚´ê¸°
socket.emit('hello_form_server', 'this is message from server')

// 'hello_from_server' ì´ë²¤íŠ¸ë¡œ ë©”ì‹œì§€ê°€ ì˜¤ë©´ í•¨ìˆ˜ ì‹¤í–‰í•˜ê¸°
socket.on('hello_from_client', message => {
  // 'this is message from clinet'
  console.log(message)
})
```

- ì›¹ì†Œì¼“ ì—°ê²°ì€ ë¬´ì¡°ê±´ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë¨¼ì € ì‹œì‘í•œë‹¤.
- ì—°ê²°í•œ ë’¤ì—ëŠ” ë©”ì‹œì§€ë¥¼ ì„œë²„ê°€ ë¨¼ì € ë³´ë‚´ë“ , í´ë¼ì´ì–¸íŠ¸ê°€ ë¨¼ì € ë³´ë‚´ë“  ìƒê´€ì—†ë‹¤.

---

### 2.2 Acknowledgement

AcknowledgementëŠ” í•œë§ˆë””ë¡œ ë©”ì‹œì§€ë¥¼ ì˜ ë°›ì•˜ë‹¤ê³  ok ì‹ í˜¸ë¥¼ ë³´ë‚´ì£¼ëŠ” ê²ë‹ˆë‹¤.

ì„œë²„ ì½”ë“œ

```ts server
/**
 * 'hello' ë£¸ì— 'world'ë¼ëŠ” ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ë‹¤.
 * 3ë²ˆì¨° íŒŒë¼ë¯¸í„°ëŠ” ì½œë°± í•¨ìˆ˜ë¡œ ã…cknowledgmentê°€ ì˜¤ë©´ ì‹¤í–‰í•œë‹¤.
 */
socket.emit('hello', 'world', response => {
  console.log(response) // ìˆ˜ì‚° ì–‘í˜¸
})
```

í´ë¼ì´ì–¸íŠ¸ ì½”ë“œ

```ts client
/**
 * 1ë²ˆì¨° íŒŒë¼ë¯¸í„° : ì´ë²¤íŠ¸ ì´ë¦„
 * 2ë²ˆì¨° íŒŒë¼ë¯¸í„° : ë©”ì‹œì§€ê°€ ì™”ì„ ë–„ ì‹¤í–‰í•  í•¨ìˆ˜
 * í•¨ìˆ˜ëŠ” 1ë²ˆì§¸ íŒŒë¼ë¯¸ë„ˆí†¨ ë©”ì‹œì§€,
 * 2ë²ˆì¨° íŒŒë¼ë¯¸í„°ë¡œ ìˆ˜ì‹  ì‘ë‹µí•  ìˆ˜ ìˆëŠ” ì½œë°±í•¨ìˆ˜ê°€ ì£¼ì–´ì§
 */
socket.on('hello', (message, callback) => {
  console.log(message) // world
  callback('ìˆ˜ì‹  ì–‘í˜¸') // ğŸ“Œ emitì„ ë‚ ë¦° ê³³ìœ¼ë¡œ ë‹¤ì‹œ ëŒì•„ê°
})
```

---

### 2.3 Namespace & Room

![namespace-room](https://raw.githubusercontent.com/berenickt/image-server/main/img/namespace-and-room.png)

- í´ë¼ì´ì–¸íŠ¸(ëª¨ë°”ì¼, ì›¹)ê°€ ì„œë²„ì— socket.io ìš”ì²­ë“¤ì„ ë„£ì„ë–„,
  - ì•„ë¬´ê²ƒë„ ì •ì˜í•˜ì§€ ì•Šìœ¼ë©´ namespaceê°€ ê¸°ë³¸ìœ¼ë¡œ `/`ê°€ ì •ì˜ëœë‹¤.
  - ì•„ë¬´ê²ƒë„ ë„£ì§€ ì•Šê³  emití•˜ë©´ `/` namespaceë¡œ ì •ì˜ëœë‹¤.
- REST APIì—ì„œ pathë¥¼ ì§œë“¯ì´, Namespaceë¼ëŠ” ê±°ë¥¼ ë§Œë“¤ê²Œ ëœë‹¤.
  - ì—¬ëŸ¬ ê°œì˜ Namespaceê°€ ìˆìœ¼ë©´, ì›í•˜ëŠ” Namespaceë¥¼ ê³¨ë¼ì„œ ìš”ì²­í•  ìˆ˜ ìˆë‹¤
- ê·¼ë° ì„œë²„ì—ì„œëŠ” namespace ì•ˆì—ì„œ ë˜ Roomìœ¼ë¡œ ë‚˜ëˆŒ ìˆ˜ê°€ ìˆë‹¤.
  - `/chat`ì— ìš”ì²­ì„ ë„£ê³  ì±„íŒ…ì„ í•œë‹¤.
  - ì´ë–„ `/chat`ì˜ ê°ê°ì˜ ë£¸ë“¤ì€ ì¹´í†¡ì—ì„œ ê°ê°ì˜ ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸ì™€ ê°™ë‹¤.
  - ê·¸ë¦¬ê³  `/noti/room1`ê³¼ `/chat/room1`ì€ ì™„ì „ ë‹¤ë¥´ê³ , ì—°ê²°ì´ ì•ˆëœë‹¤.

---

### 2.4 Namespace & Room (Server)

```ts
/***
 * ofë¥¼ ì´ìš©í•˜ë©´ namespaceë¥¼ ì •í•  ìˆ˜ ìˆë‹¤.
 * namespaceëŠ” ì¼ë°˜ì ìœ¼ë¡œ ë¼ìš°íŠ¸ í˜•íƒœë¥¼ ë”°ë¼ ì§€ì •í•œë‹¤.
 */
const chatNamespace = io.of('/chat')

// chatNmaespaceì— ì—°ê²°ëœ ì†Œì¼“ë§Œ ì•„ë˜ ì½”ë“œê°€ ì‹¤í–‰ëœë‹¤.
chatNamespace.on('connection', socket => {
  /***
   * í˜„ì¬ ì—°ê²°ëœ socketì„ room1ì— ì—°ê²°í•œë‹¤.
   * ì´ room1ì€ /chat namespaceì—ë§Œ ì¡´ì¬í•˜ëŠ” roomì´ë‹¤.
   */
  socket.join('room1')
  chatNamespace.to('room1').emit('hello', 'world')
})

// /noti namespace ìƒì„±
const notiNamespace = io.of('/noti')

// /noti chatNmaespaceì— ì—°ê²°ëœ ì†Œì¼“ë§Œ ì‹¤í–‰ëœë‹¤.
chatNamespace.on('connection', socket => {
  /***
   * ì´ room1ì€ /chat namespaceì˜ room1ê³¼ ì „í˜€ ê´€ë ¨ì´ ì—†ë‹¤.
   * ë‹¤ë¥¸ namespaceì˜ room1ì—ëŠ” ë“¤ì–´ê°ˆ ìˆ˜ ì—†ë‹¤.
   */
  socket.join('room1')

  // ì—­ì‹œë‚˜ /noti namespaceì˜ room1ì—ë§Œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ë‹¤.
  chatNamespace.to('room1').emit('hello', 'world')
})
```

---

### 2.5 Namespace & Room (Client)

```ts
// ê¸°ë³¸ namespaceë¡œ ì—°ê²° -> /
const socket = io('ws://localhost:3000') // wsëŠ” ì›¹ì†Œìº£ì˜ ì•½ì–´

// ê¸°ë³¸ namespaceë¡œ ì—°ê²° -> /chat
const chatSocket = io('ws://localhost:3000/chat')

// ê¸°ë³¸ namespaceë¡œ ì—°ê²° -> /noti
const notiSocket = io('ws://localhost:3000/noti')

/**
 * clientì—ì„œëŠ” roomì„ ì •í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì´ ì—†ë‹¤.
 * roomì€ ì„œë²„ì—ì„œë§Œ socket.join()ì„ ì‹¤í–‰í•´ì„œ,
 * íŠ¹ì • roomì— ë“¤ì–´ê°€ë„ë¡ í•  ìˆ˜ ìˆë‹¤.
 */
```

---

### 2.6 Emit & Broadcast

```ts
// ì—°ê²°ëœ ëª¨ë“  socketë“¤ì—ê²Œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ë‹¤
socket.emit('hello', 'world')

// ë‚˜ ë¹¼ê³  ëª¨ë‘ì—ê²Œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ë‹¤
socket.broadcast.emit('hello', 'world')
```

---

## 3. Gateway ìƒì„±í•˜ê³  ë©”ì‹œì§€ ë¦¬ìŠ¤ë‹í•˜ê¸°

ë¨¼ì € 3ê°œì˜ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•œë‹¤.

```bash
yarn add @nestjs/websockets @nestjs/platform-socket.io socket.io
```

ê·¸ë¦¬ê³  ë²„ì „ ì¶©ëŒì„ ë§‰ê¸° ìœ„í•´ nest íŒ¨í‚¤ì§€ë“¤ì„ ë‹¤ì‹œ ì„¤ì¹˜í•œë‹¤. ì´ë ‡ê²Œ ì•„ë˜ íŒ¨í‚¤ì§€ë“¤ì„ ë‹¤ì‹œì„¤ì¹˜í•˜ë©´ ë©”ì´ì € ë²„ì „ë“¤ì´ ë§ì¶°ì§„ë‹¤.

- @nestjs/common @nestjs/core @nestjs/jwt @nestjs/platform-express
- @nestjs/platform-socket.io @nestjs/typeorm @nestjs/websockets
- ê·¸ëŸ¬ë©´ ì´ íŒ¨í‚¤ì§€ë“¤ì— `^10.3.0`ì´ëŸ° ì‹ìœ¼ë¡œ ì•ì— `^(ìºëŸ¿)`ì´ ë¶™ëŠ”ë‹¤.

```bash
yarn add @nestjs/common @nestjs/core @nestjs/jwt @nestjs/platform-express @nestjs/platform-socket.io @nestjs/typeorm @nestjs/websockets
```

ì´ì œ chats resourceë¥¼ ìƒì„±í•œë‹¤.

```bash
$ nest g resource
? What name ? chats
? What transport layer do you use? REST API
? Would you like to generate CRUD entry points? No
```

`chats/chats.gateway.ts` íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts chats/chats.gateway.ts
import { MessageBody, OnGatewayConnection, SubscribeMessage, WebSocketGateway } from '@nestjs/websockets'
import { Socket } from 'socket.io'

@WebSocketGateway({
  // ws://localhost:3000/chats
  namespace: 'chats',
})
export class ChatsGateway implements OnGatewayConnection {
  handleConnection(socket: Socket) {
    console.log(`on connect called : ${socket.id}`)
  }

  // socket.on('send_message', (message)=>{ console.log(message)})
  @SubscribeMessage('send_message')
  sendMessage(@MessageBody() message: string) {
    console.log(message)
  }
}
```

ìœ„ì—ì„œ ë§Œë“  gatewayë¥¼ ë“±ë¡í•˜ê¸° ìœ„í•´ chats ëª¨ë“ˆì—ì„œ providerì— ë„£ì–´ì¤€ë‹¤.

```ts chats.module.ts
import { Module } from '@nestjs/common'
import { ChatsService } from './chats.service'
import { ChatsController } from './chats.controller'
import { ChatsGateway } from './chats.gateway'

@Module({
  controllers: [ChatsController],
  providers: [ChatsGateway, ChatsService],
})
export class ChatsModule {}
```

postmanì— ìœ„ìª½ new ë²„íŠ¼ì„ í´ë¦­í•˜ë©´, socket.ioê°€ ìˆë‹¤.

- ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ë§Œë“¤ê³ . socket.io ìš”ì²­ìœ¼ë¡œ `User 1 /chats`ë¼ê³  ë§Œë“ ë‹¤.
- `ws://{{host}}/chats`ë¡œ connect ìš”ì²­ì„ ë³´ë‚¸ë‹¤.
- ì›¹ì†Œì¼“ ì„œë²„ê°€ ì˜ ìƒì„±ë˜ì—ˆìœ¼ë©´, í„°ë¯¸ë„ì°½ì— ì•„ë˜ì™€ ê°™ì´ ì˜ ì—°ê²°ë˜ì—ˆë‹¤ê³  ë¯¸ë¦¬ ì‘ì„±í•´ë‘” ë©”ì‹œì§€ê°€ ëœ¬ë‹¤.
  - `on connect called : xaTkfZRExjMqwUr0AAAB`
- í¬ìŠ¤íŠ¸ë§¨ì—ì„œ emití•˜ëŠ” ë²•ì€ Message íƒ­ì—ì„œ ì¨ì£¼ê³ , ì•„ë˜ Ackì— ì´ë²¤íŠ¸ëª…ì„ ë„£ì–´ì£¼ë©´ ëœë‹¤.
  - Messageì— ì ì„ ë‚´ìš© : hello form clinet
  - Ack ì´ë²¤íŠ¸ëª… : send_message

---

## 4. ì„œë²„ì—ì„œ ì´ë²¤íŠ¸ ì „ì†¡

ì´ namespaceì— ì—°ê²°ëœ ëª¨ë“  ì†Œì¼“ë“¤í•œí…Œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ê¸°ëŠ¥ì„ ë§Œë“¤ì.

```ts chats.gateway.ts
import {
  MessageBody,
  OnGatewayConnection,
  SubscribeMessage,
  WebSocketGateway,
  WebSocketServer,
} from '@nestjs/websockets'
import { Server, Socket } from 'socket.io'

@WebSocketGateway({
  // ws://localhost:3000/chats
  namespace: 'chats',
})
export class ChatsGateway implements OnGatewayConnection {
  @WebSocketServer()
  server: Server

  handleConnection(socket: Socket) {
    console.log(`on connect called : ${socket.id}`)
  }

  // socket.on('send_message', (message)=>{ console.log(message)})
  @SubscribeMessage('send_message')
  sendMessage(@MessageBody() message: string) {
    this.server.emit('receive_message', 'hello from server')
  }
}
```

í¬ìŠ¤íŠ¸ë§¨ì—ì„œ ì„œë²„ì—ì„œ ì˜¤ëŠ” ë©”ì‹œì§€ë¥¼ ë¦¬ìŠ¤ë‹í•˜ë ¤ë©´,

- Events íƒ­ì—ì„œ íŒŒë¼ë¯¸í„°ë¥¼ ë„£ëŠ” ê²ƒì²˜ëŸ¼ ì´ë²¤íŠ¸ë¥¼ ë„£ì–´ì£¼ë©´ ëœë‹¤.

| EVENTS          | LISTEN | DESCRIPTION |
| --------------- | :----: | ----------- |
| receive_message |  ì²´í¬  |             |

í¬ìŠ¤íŠ¸ë§¨ì—ì„œ socket.io ìš”ì²­ì„ ë§Œë“¤ê³  `User 2 /chats` ë¼ê³  ì§“ëŠ”ë‹¤.

- ê·¸ë¦¬ê³  `User 2 /chats`ì˜ Events íƒ­ì„ ë‹¤ìŒê³¼ ê°™ì´ ë§Œë“ ë‹¤.

| EVENTS          | LISTEN | DESCRIPTION |
| --------------- | :----: | ----------- |
| receive_message |  ì²´í¬  |             |

ê·¸ë¦¬ê³  í„°ë¯¸ë„ ì°½ì— 2ê°œì˜ socket.io ì—°ê²°ì„ ë³´ë©´, ë‘ ì†Œì¼“ì´ ë‹¤ë¥¸ ê°’ì¸ ê±¸ ì•Œ ìˆ˜ ìˆë‹¤.

- ë˜ í¬ìŠ¤íŠ¸ë§¨ì—ì„œ socket.io ìš”ì²­ì„ ë§Œë“¤ê³  `User 3 /chats` ë¼ê³  ì§“ëŠ”ë‹¤.
- ë§ˆì°¬ê°€ì§€ë¡œ `User 3 /chats`ì˜ Events íƒ­ì„ ìœ„ì™€ ë˜‘ê°™ì´ ê°™ì´ ë§Œë“ ë‹¤.

| EVENTS          | LISTEN | DESCRIPTION |
| --------------- | :----: | ----------- |
| receive_message |  ì²´í¬  |             |

---

## 5. Room í™œìš©í•˜ê¸°

ì´ë²ˆì—ëŠ” ë°©ì„ ë‚˜ëˆ  ê°€ì§€ê³  íŠ¹ì • ë°©ì— ë“¤ì–´ì™€ ìˆëŠ” ì‚¬ìš©ìë§Œ ë©”ì‹œì§€ë¥¼ ë°›ì„ ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

- ê°ê°ì˜ ì±„íŒ…ë°© ë³„ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê¸°,
- ê·¸ëŸ´ë ¤ë©´ ì±„íŒ…ë°©ì— ë“¤ì–´ê°€ê²Œ í•˜ëŠ” ê¸°ëŠ¥ì´ í•„ìš”í•˜ë‹¤,

```ts chats.gateway.ts
// chats.gateway.ts ìƒëµ
@SubscribeMessage('enter_chat')
enterChat(
  @MessageBody() data: number[], //
  @ConnectedSocket() socket: Socket,
) {
  for (const chatId of data) {
    socket.join(chatId.toString())
  }
}

// socket.on('send_message', (message)=>{ console.log(message)})
@SubscribeMessage('send_message')
sendMessage(@MessageBody() message: { message: string; chatId: number }) {
  // ë°©ì— ë“¤ì–´ê°„ ì‚¬ìš©ìì—ê²Œë§Œ ë©”ì‹œì§€ ë³´ë‚´ê¸°
  this.server
    .in(message.chatId.toString()) //
    .emit('receive_message', message.message)
}
```

---

## 6. Broadcasting

Broadcasting : ë‚˜ë¥¼ ì œì™¸í•˜ê³  ë‹¤ë¥¸ì‚¬ëŒë“¤í•œí…Œë§Œ ë³´ë‚´ëŠ” ê²ƒ

```ts chats.gateway.ts
// chats.gateway.ts ìƒëµ
 @SubscribeMessage('send_message')
sendMessage(
  @MessageBody() message: { message: string; chatId: number },
  @ConnectedSocket() socket: Socket, //
) {
  // **** socketì€ í˜„ì¬ ì—°ê²°ëœ socketì„ ì˜ë¯¸ (ë‚˜ë¥¼ ì œì™¸í•˜ê³  ë‹¤ë¥¸ì‚¬ëŒë“¤í•œí…Œë§Œ ë³´ë‚´ê¸°)
  socket
    .to(message.chatId.toString()) //
    .emit('receive_message', message.message)

  // **** ì„œë²„ ì „ì²´ ì‚¬ìš©ìì—ê²Œë§Œ ë©”ì‹œì§€ ë³´ë‚´ê¸°
  // this.server
  //   .in(message.chatId.toString()) //
  //   .emit('receive_message', message.message)
}
```

---

## 7. Chat Entity ìƒì„±

ë°©ì„ ë§Œë“œëŠ” APIë¥¼ ë§Œë“ ë‹¤.

ì±„íŒ…ìƒì„± DTOë¥¼ ìœ„í•´ `src/chats/dto/create-chat.dto.ts` íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts src/chats/dto/create-chat.dto.ts
import { IsNumber } from 'class-validator'

export class CreateChatDto {
  @IsNumber({}, { each: true })
  userIds: number[]
}
```

ë˜ `src/chats/entity/chats.entity.ts` íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts src/chats/entity/chats.entity.ts
import { Entity, ManyToMany } from 'typeorm'
import { UsersModel } from '../../users/entities/users.entity'
import { BaseModel } from 'src/common/entities/base.entity'

@Entity()
export class ChatsModel extends BaseModel {
  @ManyToMany(() => UsersModel, user => user.chats)
  users: UsersModel[]
}
```

users ëª¨ë¸ì— ê°€ì„œ ë‹¤ëŒ€ë‹¤ ê´€ê³„ë¡œ ì—°ê²°í•  chats í”„ë¡œí¼í‹°ë¥¼ ì¶”ê°€í•œë‹¤.

```ts src/users/entities/users.entity.ts
// src/users/entities/users.entity.ts ìƒëµ
@ManyToMany(() => ChatsModel, chat => chat.users)
@JoinTable()
chats: ChatsModel[]
```

ëª¨ë“ˆì˜ ìœ„ì¹˜ë¥¼ ì°¾ì•„ì£¼ê²Œ í•˜ê¸° ìœ„í•´, app ëª¨ë“ˆì—ì„œ chats ëª¨ë¸ì„ ë„£ëŠ”ë‹¤.

```ts src/app.module.ts
// entitiesí´ë”ì— ì‘ì„±í•œ PostsModel ê°€ì ¸ì˜¤ê¸°
entities: [PostsModel, UsersModel, ImageModel, ChatsModel],
```

ì´ì œ typeormì—ì„œ ì‚¬ìš©í• ê±°ë‹ˆ chats ëª¨ë¸ì—ì„œ import í•´ì¤€ë‹¤.

```ts src/chats/chats.module.ts
import { Module } from '@nestjs/common'
import { ChatsService } from './chats.service'
import { ChatsController } from './chats.controller'
import { ChatsGateway } from './chats.gateway'
import { TypeOrmModule } from '@nestjs/typeorm'
import { ChatsModel } from './entity/chats.entity'

@Module({
  imports: [TypeOrmModule.forFeature([ChatsModel])],
  controllers: [ChatsController],
  providers: [ChatsGateway, ChatsService],
})
export class ChatsModule {}
```

ê·¸ë¦¬ê³  chats ì„œë¹„ìŠ¤ì— ê¸°ëŠ¥ì„ ì¶”ê°€í•œë‹¤.

```ts src/chats/chats.service.ts
import { Injectable } from '@nestjs/common'
import { InjectRepository } from '@nestjs/typeorm'
import { ChatsModel } from './entity/chats.entity'
import { Repository } from 'typeorm'
import { CreateChatDto } from './dto/create-chat.dto'

@Injectable()
export class ChatsService {
  constructor(
    @InjectRepository(ChatsModel)
    private readonly chatsRepository: Repository<ChatsModel>,
  ) {}

  async createChat(dto: CreateChatDto) {
    const chat = await this.chatsRepository.save({
      users: dto.userIds.map(id => ({ id })),
    })

    return this.chatsRepository.findOne({
      where: { id: chat.id },
    })
  }
}
```

ì´ì œ ì´ ê¸°ëŠ¥ì„ gatewayì—ì„œ ì‚¬ìš©í•œë‹¤.

```ts src/chats/chats.gateway.ts
// ìƒëµ
@WebSocketGateway({
  // ws://localhost:3000/chats
  namespace: 'chats',
})
export class ChatsGateway implements OnGatewayConnection {
  constructor(private readonly chatService: ChatsService) {}

  // ìƒëµ

  @SubscribeMessage('create_chat')
  async createChat(@MessageBody() data: CreateChatDto) {
    const chat = await this.chatService.createChat(data)
  }

  // ìƒëµ
}
```

---

## 8. Pagination Chat API ìƒì„±

`chats/dto/paginate-chat.dto.ts `íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts src/chats/dto/paginate-chat.dto.ts
import { BasePaginationDto } from 'src/common/dto/base-pagination.dto'

export class PaginateChatDto extends BasePaginationDto {}
```

ì‘ì„±í•œ DTOë¥¼ chats ì„œë¹„ìŠ¤ì— ì ìš©í•œë‹¤.

```ts src/chats/chats.service.ts
// ìƒëµ
@Injectable()
export class ChatsService {
  constructor(
    @InjectRepository(ChatsModel)
    private readonly chatsRepository: Repository<ChatsModel>,
    private readonly commonService: CommonService,
  ) {}

  paginateChats(dto: PaginateChatDto) {
    return this.commonService.paginate(
      dto, //
      this.chatsRepository,
      { relations: { users: true } },
      'chats',
    )
  }
  // ìƒëµ
}
```

chats ì»¨íŠ¸ë¡¤ëŸ¬ì— ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì¶”ê°€í•œë‹¤.

```ts src/chats/chats.controller.ts
import { Controller, Get, Query } from '@nestjs/common'
import { ChatsService } from './chats.service'
import { PaginateChatDto } from './dto/paginate-chat.dto'

@Controller('chats')
export class ChatsController {
  constructor(private readonly chatsService: ChatsService) {}

  @Get()
  paginateChat(@Query() dto: PaginateChatDto) {
    return this.chatsService.paginateChats(dto)
  }
}
```

ê·¸ë¦¬ê³  chats ëª¨ë“ˆì— Commonëª¨ë“ˆì„ importí•´ì¤€ë‹¤.

```ts src/chats/chats.module.ts
// ìƒëµ
@Module({
  imports: [
    TypeOrmModule.forFeature([ChatsModel]), //
    CommonModule,
  ],
  controllers: [ChatsController],
  providers: [ChatsGateway, ChatsService],
})
export class ChatsModule {}
```

---

## 9. Enter Chat ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸ & WSException ë˜ì§€ê¸°

Enterchat DTOë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•´ `chats/dto/enter-chat.dto.ts`íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts src/chats/dto/enter-chat.dto.ts
import { IsNumber } from 'class-validator'

export class EnterChatDto {
  @IsNumber({}, { each: true })
  chatIds: number[]
}
```

chats ì„œë¹„ìŠ¤ì— ì§„ì§œ ì±„íŒ…ë°©ì„ ë‚˜ê°ˆê±´ì§€ ì²´í¬í•˜ëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€í•œë‹¤.

```ts src/chats/chats.service.ts
// chats/chats.service.ts ìƒëµ
async checkIfChatExists(chatId: number) {
  const exists = await this.chatsRepository.exist({
    where: {
      id: chatId,
    },
  })
  return exists
}
```

ì‘ì„±í•œ ê¸°ëŠ¥ì„ chats gatewayì— ì ìš©í•œë‹¤

```ts src/chats/chats.gateway.ts
// src/chats/chats.gateway.ts ìƒëµ
@SubscribeMessage('enter_chat')
async enterChat(@MessageBody() data: EnterChatDto, @ConnectedSocket() socket: Socket) {
  for (const chatId of data.chatIds) {
    const exists = await this.chatService.checkIfChatExists(chatId)
    if (!exists) {
      throw new WsException({
        code: 100,
        message: `ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì±„íŒ…ë°©ì…ë‹ˆë‹¤! ::: ChatID: ${chatId}`,
      })
    }
  }
  socket.join(data.chatIds.map(id => id.toString()))
}
```

---

## 10. ë©”ì‹œì§€ ë³´ë‚´ê¸° ë§ˆë¬´ë¦¬

`chats/messages/entity/messages.entity.ts` íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts src/chats/messages/entity/messages.entity.ts
import { IsString } from 'class-validator'
import { ChatsModel } from 'src/chats/entity/chats.entity'
import { BaseModel } from 'src/common/entities/base.entity'
import { UsersModel } from 'src/users/entities/users.entity'
import { Column, Entity, ManyToOne } from 'typeorm'

@Entity()
export class MessagesModel extends BaseModel {
  @ManyToOne(() => ChatsModel, chat => chat.messages)
  chat: ChatsModel

  @ManyToOne(() => UsersModel, user => user.messages)
  author: UsersModel

  @Column()
  @IsString()
  message: string
}
```

`src/chats/entity/chats.entity.ts`ì—ì„œ ì—°ê²°í•´ì¤€ë‹¤.

```ts src/chats/entity/chats.entity.ts
import { Entity, ManyToMany, OneToMany } from 'typeorm'
import { UsersModel } from '../../users/entities/users.entity'
import { BaseModel } from 'src/common/entities/base.entity'
import { MessagesModel } from '../messages/entitiy/messages.entity'

@Entity()
export class ChatsModel extends BaseModel {
  @ManyToMany(() => UsersModel, user => user.chats)
  users: UsersModel[]

  @OneToMany(() => MessagesModel, message => message.chat)
  messages: MessagesModel[]
}
```

`src/users/entities/users.entity.ts`ì—ë„ ê´€ê³„ ì—°ê²°í•´ì¤€ë‹¤.

```ts src/users/entities/users.entity.ts
// src/users/entities/users.entity.ts ìƒëµ
@OneToMany(() => MessagesModel, message => message.author)
messages: MessagesModel[]
```

ê·¸ë¦¬ê³  app ëª¨ë“ˆì—ì„œ MessagesModelì„ ë„£ì–´ì¤€ë‹¤

```ts src/app.module.ts
// src/app.module.ts ìƒëµ
entities: [
  PostsModel, //
  UsersModel,
  ImageModel,
  ChatsModel,
  MessagesModel,
],
```

`src/chats/messages/dto/create-message.dto.ts` íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts src/chats/messages/dto/create-message.dto.ts
import { PickType } from '@nestjs/mapped-types'
import { IsNumber } from 'class-validator'
import { MessagesModel } from '../entitiy/messages.entity'

export class CreateMessagesDto extends PickType(MessagesModel, ['message']) {
  @IsNumber()
  chatId: number
}
```

`src/chats/messages/messages.service.ts` íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts src/chats/messages/messages.service.ts
import { Injectable } from '@nestjs/common'
import { InjectRepository } from '@nestjs/typeorm'
import { FindManyOptions, Repository } from 'typeorm'
import { CommonService } from 'src/common/common.service'
import { BasePaginationDto } from 'src/common/dto/base-pagination.dto'
import { MessagesModel } from './entitiy/messages.entity'
import { CreateMessagesDto } from './dto/create-messages.dto'

@Injectable()
export class ChatsMessagesService {
  constructor(
    @InjectRepository(MessagesModel)
    private readonly messagesRepository: Repository<MessagesModel>,
    private readonly commonService: CommonService,
  ) {}

  async createMessage(dto: CreateMessagesDto, authorId: number) {
    const message = await this.messagesRepository.save({
      chat: {
        id: dto.chatId,
      },
      author: {
        id: authorId,
      },
      message: dto.message,
    })

    return this.messagesRepository.findOne({
      where: {
        id: message.id,
      },
      relations: {
        chat: true,
      },
    })
  }

  paginteMessages(dto: BasePaginationDto, overrideFindOptions: FindManyOptions<MessagesModel>) {
    return this.commonService.paginate(
      dto, //
      this.messagesRepository,
      overrideFindOptions,
      'messages',
    )
  }
}
```

chats ëª¨ë“ˆì—ë‹¤ê°€ ë“±ë¡í•´ì¤€ë‹¤.

```ts chats.module.ts
// ìƒëµ
@Module({
  imports: [
    TypeOrmModule.forFeature([ChatsModel, MessagesModel]), //
    CommonModule,
  ],
  controllers: [ChatsController],
  providers: [
    ChatsGateway,
    ChatsService, //
    ChatsMessagesService,
  ],
})
export class ChatsModule {}
```

chats.gatewayë¥¼ ìˆ˜ì •í•œë‹¤.

```ts src/chats/chats.gateway.ts
// ìƒëµ
@WebSocketGateway({
  // ws://localhost:3000/chats
  namespace: 'chats',
})
export class ChatsGateway implements OnGatewayConnection {
  constructor(
    private readonly chatsService: ChatsService,
    private readonly messageService: ChatsMessagesService,
  ) {}
  // ìƒëµ
  @SubscribeMessage('send_message')
  async sendMessage(@MessageBody() dto: CreateMessagesDto, @ConnectedSocket() socket: Socket) {
    const chatExists = await this.chatsService.checkIfChatExists(dto.chatId)

    if (!chatExists) {
      throw new WsException({
        code: 100,
        message: `ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì±„íŒ…ë°©ì…ë‹ˆë‹¤! ::: ChatID: ${dto.chatId}`,
      })
    }

    const message = await this.messageService.createMessage(dto)
    socket.to(message.chat.id.toString()).emit('receive_message', message.message)
  }
}
```

`messages.controller.ts` íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts messages.controller.ts
import { Controller, Get, Param, ParseIntPipe, Query } from '@nestjs/common'
import { ChatsMessagesService } from './messages.service'
import { BasePaginationDto } from 'src/common/dto/base-pagination.dto'

@Controller('chats/:cid/messages')
export class MessagesController {
  constructor(private readonly messagesService: ChatsMessagesService) {}

  @Get()
  paginateMessage(
    @Param('cid', ParseIntPipe) id: number, //
    @Query() dto: BasePaginationDto,
  ) {
    return this.messagesService.paginteMessages(dto, {
      where: {
        chat: {
          id,
        },
      },
      relations: {
        author: true,
        chat: true,
      },
    })
  }
}
```
